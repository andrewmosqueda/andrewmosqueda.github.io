<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board - Andrew Mosqueda</title><meta name="description" content="INTRODUCTION I will demonstrate here how to convert the previous voltage mode buck converter discussed in Voltage Mode Buck Converter to current mode. The code of the voltage mode buck converter is stored here --&gt; Voltage Mode Buck Converter - MPLAB source code. Before doing&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://andrewmosqueda.github.io/current-mode/"><link rel="alternate" type="application/atom+xml" href="https://andrewmosqueda.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://andrewmosqueda.github.io/feed.json"><meta property="og:title" content="5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board"><meta property="og:site_name" content="Andrew Mosqueda - Andrew Mosqueda"><meta property="og:description" content="INTRODUCTION I will demonstrate here how to convert the previous voltage mode buck converter discussed in Voltage Mode Buck Converter to current mode. The code of the voltage mode buck converter is stored here --&gt; Voltage Mode Buck Converter - MPLAB source code. Before doing&hellip;"><meta property="og:url" content="https://andrewmosqueda.github.io/current-mode/"><meta property="og:type" content="article"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--post-entry-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://andrewmosqueda.github.io/assets/css/style.css?v=eacb492672ba3c1641d647982de266ba"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrewmosqueda.github.io/current-mode/"},"headline":"5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board","datePublished":"2021-09-11T21:52","dateModified":"2021-09-30T21:05","description":"INTRODUCTION I will demonstrate here how to convert the previous voltage mode buck converter discussed in Voltage Mode Buck Converter to current mode. The code of the voltage mode buck converter is stored here --&gt; Voltage Mode Buck Converter - MPLAB source code. Before doing&hellip;","author":{"@type":"Person","name":"Andrew Mosqueda"},"publisher":{"@type":"Organization","name":"Andrew Mosqueda"}}</script></head><body><header class="topbar" id="js-header"><div class="topbar__inner"><a class="logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2021-09-30T21:05">September 30, 2021</time></div><div class="infobar__search"><form action="https://andrewmosqueda.github.io/search.html"><input type="search" name="q" placeholder="search..." aria-label="Search input"> <button type="submit" aria-label="Submit"><svg role="presentation" focusable="false" width="15px" height="14px"><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#search"/></svg></button></form></div></div><main class="main"><article class="post"><header class="u-header post__header"><h1>5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</h1><div class="u-header__meta u-small"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="eager" class="u-header__avatar" alt="Andrew Mosqueda"><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a> <time datetime="2021-09-11T21:52">September 11, 2021</time></div></div></header><div class="post__entry u-inner"><h2>INTRODUCTION</h2><p>I will demonstrate here how to convert the previous voltage mode buck converter discussed in <a href="https://andrewmosqueda.github.io/implementing-5v-to-33v-buck-converter-in-the-dspic33ch-curiosity-development-board/" target="_blank" rel="noopener noreferrer">Voltage Mode Buck Converter</a> to current mode. The code of the voltage mode buck converter is stored here --&gt; <a href="https://andrewmosqueda.github.io/media/files/DM330028 buck converter vmode MPLAB.zip" target="_blank" rel="noopener noreferrer">Voltage Mode Buck Converter - MPLAB source code</a>.</p><figure class="post__image">Below is the simplified schematic of the DM330028 board's buck converter with the dsPIC33CH128MP508 I/Os. In contrast with the voltage mode converter, the IC has additional input to monitor the Power MOSFET current via RA3_ISENSEH pin. The High-Speed Analog Comparator Module is utilized to monitor this current. The duty cycle of the PWM duty cycle is also fixed to a high value (95%). Instead of the PID function changing the PWM duty cycle, its result is converted into an analog voltage by the DAC and compared to the power MOSFET current by the Comparator. So when the sense current exceeds the DAC output, the comparator output will turn high. Inside the PWM module, there is a PWM Control Input Current Limit (PCI CL) logic circuit that monitors the analog comparator output and PWM states like End-of-Cycle (EOC). The PCI CL output toggles and truncates the PWM output whenever the Analog Comparator output turns high. It then resets after detecting PWM EOC.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/close-loop-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/close-loop-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/close-loop-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/close-loop-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/close-loop-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/close-loop-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/close-loop-2-2xl.jpg 1600w" alt="Current Mode Buck Converter" width="983" height="578"></figure><p>Before doing the coding, it is good to understand first each circuit and modules.</p><p>CURRENT SENSE CIRCUIT</p><p>The power MOSFET Q6 high side current sense circuit is shown below. The voltage drop at R59 and R74 resistors is used to monitor the current at Q6. The purpose of R97 and R102 divider resistors is to make a positive bias at the dsPIC analog input pin. According to DS50002762A document, the purpose of the intentional small bias is to ensure that the current sense voltage signal is always within the internal analog comparator input sensing range and the internal DAC reachable range.</p><p>I have written the derivation of the equations in mathcad (<a href="https://andrewmosqueda.github.io/media/files/High Side Current Measurement.mcdx" target="_blank" rel="noopener noreferrer">get mathcad file here</a>) and simulate in LTSPICE (<a href="https://andrewmosqueda.github.io/high-side-current-sense-circuit-simulation/" target="_blank" rel="noopener noreferrer">High Side Current Sense LTSPICE Simulation</a>) to easily understand the circuit. </p><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/current-sense-resistors.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-resistors-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-resistors-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-resistors-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-resistors-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-resistors-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-resistors-2xl.jpg 1600w" alt="DM330028 Current Sense Resistors" width="406" height="207"></figure><figure class="post__image"><br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/current-sense-circuit-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-circuit-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-circuit-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-circuit-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-circuit-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-circuit-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/current-sense-circuit-2-2xl.jpg 1600w" alt="High side current sense amplifier" width="743" height="417"></figure><p>ANALOG COMPARATOR MODULE</p><figure class="post__image">The RA3 pin of the dsPIC33CH IC will be configured as +input to an internal analog comparator. Below is the diagram of the internal analog comparator of the DSPIC33 IC  that is defined in DS70005280B document. The INSEL&lt;2:0&gt; register is set to S1CMP1A because this is the one connected to the RA3 pin. The PDM (Pulse Density Modulation) generates an analog voltage with level that depends on the values stored on SLPxDAT, DACxDATH and DACxDATL registers. The SLPxDAT and DACxDATL are used in slope compensation. For simplicity of this exercise, the slope compensation feature of the PDM is disabled so the output will just depend on the DACxDATH register. The PID value (compensated error value, see topic <a href="https://andrewmosqueda.github.io/implementing-5v-to-33v-buck-converter-in-the-dspic33ch-curiosity-development-board/" target="_blank" rel="noopener noreferrer">Voltage Mode Converter</a> topic) is then stored to the DACxDATH register to dynamically adjust the comparator current threshold. DACOUT1 can be used to monitor the actual output of the PDM by an oscilloscope. The Digital Filter will also be enabled to filter unwanted output due to switching noise.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/Comparator.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-2xl.jpg 1600w" alt="DSPIC33 High Speed Comparator Module" width="873" height="565"></figure><p>PWM CONTROL INPUT CURRENT LIMIT (PCI CL)</p><figure class="post__image">The output of the internal analog comparator described above is then fed to an internal PCI logic circuit as shown below.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/pci.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/pci-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/pci-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/pci-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/pci-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/pci-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/pci-2xl.jpg 1600w" alt="PCI Function Block Diagram" width="933" height="656"></figure><p>The PCI Acceptance logic block above has three dynamic inputs; <strong>PCI Source, Qualifier </strong>and <strong>Terminator</strong>. Its ACP register is set so that it becomes Latched Mode. The Latched Mode logic is shown below.</p><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/PCI-acceptance-logic-latched-mode.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/PCI-acceptance-logic-latched-mode-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/PCI-acceptance-logic-latched-mode-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/PCI-acceptance-logic-latched-mode-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/PCI-acceptance-logic-latched-mode-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/PCI-acceptance-logic-latched-mode-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/PCI-acceptance-logic-latched-mode-2xl.jpg 1600w" alt="PCI Acceptance Logic in Latched Mode" width="269" height="151"></figure><p>The input to the <strong>PCI Source</strong> is set from the analog comparator output. The input to the <strong>Qualifier </strong>is set as LEB (Leading Edge Blanking Active). The LEB is a counter which starts after PWM7H (PWM output) rises up and resets/stop when PWM7H falls down .The purpose of the LEB qualifier is to prevent unwanted turn off of the PWM during start of cycle due to unwanted transients during switching. The input to the <strong>Terminator </strong>is the AND of Auto-Terminate and EOC Event. Auto-Terminate becomes high when the analog comparator transitions from high to low. The auto-terminate ensures  that the PWM output is turned off while the current is above threshold even if the EOC Event is already reached. </p><p>I have simulated the PCI CL with the comparator, PWM and the buck converter circuit in LTSPICE to have better insight about the circuit operation. See <a href="https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/" target="_blank" rel="noopener noreferrer">PCI Current Limit Simulation.</a></p><h2>PROCEDURE</h2><ol><li>Save the buck converter files to a different folder. </li><li>Open MPLAB X IDE. After opening, close any opened projects.</li><li>Open the master and slave projects of the voltage mode buck converter.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/projects.PNG" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/projects-xs.PNG 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/projects-sm.PNG 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/projects-md.PNG 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/projects-lg.PNG 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/projects-xl.PNG 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/projects-2xl.PNG 1600w" alt="MPLAB Projects pane" width="190" height="390"></figure></li><li>Ensure that the master project is the main project.</li><li>Click the MCC button and wait the MCC to finish loading.</li><li>In the Pin Manager: Grid View, set RB2 as owned by Slave Core. This pin will be used to monitor the the DAC reference for the internal analog comparator by an oscilloscope.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/Pin-Manager-RB2-DACout-slave-owned.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/Pin-Manager-RB2-DACout-slave-owned-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/Pin-Manager-RB2-DACout-slave-owned-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/Pin-Manager-RB2-DACout-slave-owned-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/Pin-Manager-RB2-DACout-slave-owned-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/Pin-Manager-RB2-DACout-slave-owned-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/Pin-Manager-RB2-DACout-slave-owned-2xl.jpg 1600w" alt="MPLAB MCC Pin Manager" width="612" height="173"></figure></li><li>Click the Slave Core on the Project Resources pane to open the Slave Core Configuration.</li><li>Click Slave Master Settings button.</li><li>In the Project Resources pane, click the Generate button. Wait for the Generation Complete message to appear on the output prompt window.</li><li> Click the MCC button to close the MCC application.</li><li>Go back to the Projects tab on the left pane and set the slave project as Main Project.</li><li>Click the MCC button and wait the MCC to finish loading.</li><li>On the Master Core configuration pane, click the Load Slave Settings from Master Configuration button. Locate and select the master_config.mc3 file that was generated by the master project MCC and then after that click the open button.</li><li>On the System Module pane, tick PLL Enable, select 1:100 as Feedback and FVCO/2 as AVCO Divider. These frequency settings are needed for the DAC of the Analog Comprator to function properly.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/system-module.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/system-module-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/system-module-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/system-module-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/system-module-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/system-module-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/system-module-2xl.jpg 1600w" alt="MPLAB MCC System Module Settings" width="471" height="381"></figure></li><li>On the Device Resources pane, click the + of CMP1 to move it to the Project Resources pane.</li><li>On the CMP1 settings, tick Enable Comparator, Enable Digital Filter and Enable DAC Output. The digital filter is utilized to help filter out switching noises. The DAC output does not help on the operation of the comparator but is used to monitor and debug the comparator.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/Comparator-Settings.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-Settings-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-Settings-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-Settings-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-Settings-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-Settings-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/Comparator-Settings-2xl.jpg 1600w" alt="MPLAB MCC CMP1 settings" width="580" height="488"></figure></li><li>On the pin manager, let RA3 assigned to S1CMP1A. RA3 pin is connected to the output of the high current sense circuit of DM330038 board. Note that S1CMP1A is the one selected as the non-inverting input of the analog comparator on the above image.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/S1CMP1A.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/S1CMP1A-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/S1CMP1A-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/S1CMP1A-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/S1CMP1A-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/S1CMP1A-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/S1CMP1A-2xl.jpg 1600w" alt="MPLAB MCC Pin Manager" width="408" height="265"></figure></li><li>On the project resources pane, click on PWM to open the PWM configuration.</li><li>Set the fixed Duty Cycle to 95%. <br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/PWM-duty-cycle.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/PWM-duty-cycle-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/PWM-duty-cycle-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/PWM-duty-cycle-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/PWM-duty-cycle-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/PWM-duty-cycle-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/PWM-duty-cycle-2xl.jpg 1600w" alt="MPLAB MCC PWM duty cycle settings" width="365" height="90"></figure></li><li>Click on the Registers tab of the PWM settings. Wait the Registers tab to finish loading.</li><li>Change the PG7CLPCIH settings to the same values with the image below. This register contains some of the settings to make the PCI becomes a current limit logic (<a href="https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/" target="_blank" rel="noopener noreferrer">See PCI-Current Limit Logic for more details</a>).<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/PG7CLPCIH.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIH-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIH-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIH-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIH-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIH-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIH-2xl.jpg 1600w" alt="MPLAB MCC PG7CLPCIH Settings" width="306" height="350"></figure></li><li>Change the PG7CLPCIL settings to the same values with the image below. This register contains the other settings to make the PCI becomes a current limit logic (<a href="https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/" target="_blank" rel="noopener noreferrer">See PCI-Current Limit Logic for more details</a>). Also Slave Comparator 1 output is assigned as the input to the current limit logic.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/PG7CLPCIL.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIL-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIL-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIL-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIL-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIL-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7CLPCIL-2xl.jpg 1600w" alt="MPLAB MCC PG7CLPCIL" width="357" height="350"></figure></li><li>In the PG7IOCONH register, change the PENL value to disabled. This value ensures that the low side MOSFET does not turn on.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/PG7IOCONH.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/PG7IOCONH-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7IOCONH-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7IOCONH-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7IOCONH-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7IOCONH-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7IOCONH-2xl.jpg 1600w" alt="MPLAB MCC PG7IOCONH Settings" width="322" height="315"></figure></li><li>In the PG7LEBH register, change the PHF to enabled and PWMPCI to 7. The PHF means the PWM7H falling edge will trigger the LEB duration counter. We use a falling edge because we are driving a P MOSFET and a P MOSFET requires a negative polarity drive.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/PG7LEBH-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/PG7LEBH-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7LEBH-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7LEBH-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7LEBH-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7LEBH-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/PG7LEBH-2-2xl.jpg 1600w" alt="MPLAB MCC PG7LEBH Register" width="200" height="241"></figure></li><li>On the Project Resources pane, click the Generate button, click Yes button on the MCC Warning confirmation and wait until Generation Complete message is displayed on the output prompt.</li><li>Click the MCC button to close MCC. </li><li>Open main.c file of the slave project.</li><li>In the PID(void) interrupt handler function, In the last line replace PG7DC by DAC1DATH.  Basically, this means that the PID now is now fed to the Slave Comparator 1 negative input instead of directly adjusting the duty cycle of the PWM. At the end of the code append "+260" so that the code now becomes: DAC1DATH = n16_integrator_memory + n16_proportional + 260;. The 260 value is compensation to the offset introduced by current sense circuit.</li><li>On line 62 and 63, Change the p_gain to 0.5 and i_gain to 0.1.</li><li>Set the master project as the Main Project.</li><li>Connect the Curiosity Development Board to the PC.</li><li>Click the make and program device button.</li><li>Wait until the Programming/Verify complete is prompted in the output prompt window.</li></ol><h2>RESULT</h2><p>Oscilloscope used: ADALM2000<br>Load:100Ω (Remove power while connecting the load).</p><figure class="post__image">Below are the waveforms for RA3 (Orange, Current Sense Voltage) and RB2 (Purple, DAC output). These two waveforms are the input to the analog comparator.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/RA3vsRB2-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRB2-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRB2-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRB2-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRB2-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRB2-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRB2-2-2xl.jpg 1600w" alt="Sensed Current and DAC waveform" width="1377" height="768"></figure><figure class="post__image">Below are the waveforms of RA3 (Orange, Current Sense Voltage) and RC14 (Purple, PWM7H output).<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/RA3vsRC14-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRC14-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRC14-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRC14-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRC14-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRC14-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsRC14-2-2xl.jpg 1600w" alt="Current Sense and PWM7H waveform" width="1371" height="768"></figure><figure class="post__image">Below are the waveforms of RA3 (Orange, Current Sense Voltage) and VOUT (The output voltage of the converter). Output is the same with the voltage mode converter. See <a href="https://andrewmosqueda.github.io/implementing-5v-to-33v-buck-converter-in-the-dspic33ch-curiosity-development-board/" target="_blank" rel="noopener noreferrer">Voltage mode buck converter</a><br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/6/RA3vsVout.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsVout-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsVout-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsVout-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsVout-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsVout-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/6/responsive/RA3vsVout-2xl.jpg 1600w" alt="Current Sense Voltage and Converter Output Voltage" width="1372" height="771"></figure><p> </p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on September 30, 2021</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio box"><img class="u-author__avatar" src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="lazy" alt="Andrew Mosqueda"><div><h4 class="h6"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://andrewmosqueda.github.io/debugging-dspic-using-uart-and-switch-interrupt/" class="post__nav__link" rel="prev"><div class="u-small">Previous Post<h5>Print debugging dsPIC in Real Time using UART and switch Interrupt</h5></div></a></div><div class="post__nav__next"><a href="https://andrewmosqueda.github.io/high-side-current-sense-circuit-simulation/" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>High Side Current Sense Circuit Simulation</h5></div></a></div></nav><div class="post__related box"><h3 class="box__title">Related posts</h3><div class="post__related-wrap"><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/" class="inverse">Simulation of the PCI-Current Limit Logic of dsPIC33CH</a></h4><time datetime="2021-09-26T17:12" class="u-small">September 26, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/high-side-current-sense-circuit-simulation/" class="inverse">High Side Current Sense Circuit Simulation</a></h4><time datetime="2021-09-25T08:56" class="u-small">September 25, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/implementing-5v-to-12v-pwm-boos-converter-in-the-dspic33ch-curiosity-development-board/" class="inverse">Implementing 5V to 12V PWM Boost Converter in the DSPIC33CH Curiosity Development Board</a></h4><time datetime="2021-08-17T20:18" class="u-small">August 17, 2021</time></figcaption></figure></div></div></footer></article><div class="comments box"><h3 class="box__title">Comments</h3><div id="disqus_thread"></div><script>var disqus_config = function () {
                    this.page.url = 'https://andrewmosqueda.github.io/current-mode/';
            		this.page.identifier = '6';
                };
            
                var disqus_loaded = false;
            
                function publiiLoadDisqus() {
                    if(disqus_loaded) {
                        return false;
                    }
            
                    var top = document.getElementById('disqus_thread').offsetTop;
            
                    if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                        disqus_loaded = true;
            
                        (function () {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    }
                }
            
                publiiLoadDisqus();
            
                window.onscroll = function() {
                    publiiLoadDisqus();
                };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></main><div class="sidebar"><section class="box featured"><h3 class="box__title">Featured</h3><ul class="featured__container"><li class="featured__item"><div><a href="https://andrewmosqueda.github.io/simulation-of-buck-converter-using-discrete-pid-in-ltspice/" class="featured__title">Simulation of Buck Converter using discrete PID in LTSPICE</a> <time class="u-small" datetime="2021-08-08T11:14">August 8, 2021</time></div></li></ul></section><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__image-link"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" alt="Andrew Mosqueda"></a><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__title">Andrew Mosqueda</a> <span class="u-small">Post: 8</span></div></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a><nav><ul class="footer__nav"></ul></nav><div class="footer__follow"><a href="https://www.facebook.com/andrew.mosqueda" aria-label="Facebook"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://www.linkedin.com/in/alex-andrew-mosqueda-31197876/" aria-label="LinkedIn"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#linkedin"/></svg> </a><a href="https://www.youtube.com/channel/UCHcJ7jRLmntRZrI8h41y3Yg" aria-label="Youtube"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#youtube"/></svg></a></div><div class="footer__copyright"><p>andrewgs7311@gmail.com</p></div></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://andrewmosqueda.github.io/assets/js/scripts.min.js?v=3dc768003cc6d66c9e7bf0904e71d3e8"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>