<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Hysteretic Current Mode Buck Converter with dsPIC33 - Andrew Mosqueda</title><meta name="description" content="INTRODUCTION In this article, a hysteretic current control for a 5V to 3.3V buck converter will be implemented in the DM330028 dsPIC33CH Curiosity Development Board. The buck inductor current in a hysteretic current mode flows in a critical conduction so the controller must immediately turn&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://andrewmosqueda.github.io/hysteretic-current-mode-buck-converter-for-dspic33/"><link rel="alternate" type="application/atom+xml" href="https://andrewmosqueda.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://andrewmosqueda.github.io/feed.json"><meta property="og:title" content="Hysteretic Current Mode Buck Converter with dsPIC33"><meta property="og:site_name" content="Andrew Mosqueda - Andrew Mosqueda"><meta property="og:description" content="INTRODUCTION In this article, a hysteretic current control for a 5V to 3.3V buck converter will be implemented in the DM330028 dsPIC33CH Curiosity Development Board. The buck inductor current in a hysteretic current mode flows in a critical conduction so the controller must immediately turn&hellip;"><meta property="og:url" content="https://andrewmosqueda.github.io/hysteretic-current-mode-buck-converter-for-dspic33/"><meta property="og:type" content="article"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--post-entry-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://andrewmosqueda.github.io/assets/css/style.css?v=eacb492672ba3c1641d647982de266ba"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrewmosqueda.github.io/hysteretic-current-mode-buck-converter-for-dspic33/"},"headline":"Hysteretic Current Mode Buck Converter with dsPIC33","datePublished":"2021-11-24T20:07","dateModified":"2021-11-28T16:36","description":"INTRODUCTION In this article, a hysteretic current control for a 5V to 3.3V buck converter will be implemented in the DM330028 dsPIC33CH Curiosity Development Board. The buck inductor current in a hysteretic current mode flows in a critical conduction so the controller must immediately turn&hellip;","author":{"@type":"Person","name":"Andrew Mosqueda"},"publisher":{"@type":"Organization","name":"Andrew Mosqueda"}}</script></head><body><header class="topbar" id="js-header"><div class="topbar__inner"><a class="logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2021-11-28T16:36">November 28, 2021</time></div><div class="infobar__search"><form action="https://andrewmosqueda.github.io/search.html"><input type="search" name="q" placeholder="search..." aria-label="Search input"> <button type="submit" aria-label="Submit"><svg role="presentation" focusable="false" width="15px" height="14px"><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#search"/></svg></button></form></div></div><main class="main"><article class="post"><header class="u-header post__header"><h1>Hysteretic Current Mode Buck Converter with dsPIC33</h1><div class="u-header__meta u-small"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="eager" class="u-header__avatar" alt="Andrew Mosqueda"><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a> <time datetime="2021-11-24T20:07">November 24, 2021</time></div></div></header><div class="post__entry u-inner"><h2>INTRODUCTION</h2><figure class="post__image">In this article, a hysteretic current control for a 5V to 3.3V buck converter will be implemented in the DM330028 dsPIC33CH Curiosity Development Board. The buck inductor current in a hysteretic current mode flows in a critical conduction so the controller must immediately turn on the MOSFET upon detecting the inductor current has returned to zero. When the MOSFET is turned on, the controller must immediately turn off the MOSFET when the target peak current is reached. The target peak current is calculated by a PID algorithm. Below is the buck/boost circuit of the DM330028 board.  There is no direct current sense for the inductor L1 but the high side current sense (R59/R74) resistors can be utilized to measure the rising inductor current when Q6 is on and the low side (R93/R92/R63) current sense resistors can be utilized to measure the decreasing inductor current when Q6 is off.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/power-circuit.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/power-circuit-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/power-circuit-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/power-circuit-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/power-circuit-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/power-circuit-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/power-circuit-2xl.jpg 1600w" alt="dsPIC33CH Curiosity Development Board Buck/Boost Converter" width="966" height="452"></figure><figure class="post__image">The inputs for the close loop system are the high side current (ISENSEH_BIASED), the low side current (RD14_ISENSEL pin) and the output voltage (Vout). Below is the circuit on the DM330028 board that converts the high side current sense voltage into a level that is within the range of the dsPIC33 input (RA3_ISENSEH pin). The signal on RA3_ISENSEH will be fed to the + input of a built analog comparator of the dsPIC33CH IC. The - input of the comparator is a DAC that will be fed by a calculated value from a PID algorithm.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/high-side-current-level-shifter.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/high-side-current-level-shifter-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/high-side-current-level-shifter-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/high-side-current-level-shifter-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/high-side-current-level-shifter-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/high-side-current-level-shifter-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/high-side-current-level-shifter-2xl.jpg 1600w" alt="High Side Current Sense Circuit" width="556" height="338"></figure><figure class="post__image">The PID algorithm is based on the sensed voltage from the Vout sense. Below is the output voltage sense circuit. The sensed voltage  is RC1_VOUTFB. RC1_VOUTFB will be fed to an ADC and then processed in the PID algorithm.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/output-voltage-feedback-sense.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/output-voltage-feedback-sense-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/output-voltage-feedback-sense-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/output-voltage-feedback-sense-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/output-voltage-feedback-sense-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/output-voltage-feedback-sense-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/output-voltage-feedback-sense-2xl.jpg 1600w" alt="voltage feedback sense circuit" width="536" height="298"></figure><p>The third input (RD14_ISENSEL) to the control loop has a negative voltage level when MOSFET Q6 is off and inductor L1 is conducting. This negative level voltage is fed to the -input of a programmable gain amplifier to have a positive output value. The DS50002762A document recommends x8 as the gain setting for this signal. The output of the programmable gain amplifier is then fed to another comparator to detect that the current on the inductor has return to zero.</p><p>The first comparator and second comparator outputs are then fed to a built in SR logic circuit as S and R inputs respectively. The output of the SR logic then serves as the drive for MOSFET Q6. For more details or insight on the hysteretic operation, you can check my previous article <a href="https://andrewmosqueda.github.io/hysteretic-current-mode-buck-converter-for-dspic33/" target="_blank" rel="noopener noreferrer">LTspice - Hysteretic Current Mode Buck Converter.</a> </p><h2>MASTER CORE GENERATION</h2><p>The master core here is only used to enable the slave core. All close loop operation will be done on the slave core.</p><ol><li>Run MPLAB X IDE (I'm using version v5.50 at the time of this writing). Connect J20 of the DM330028 Curiosity Development Board to your PC so that the MPLAB application detects what board is connected.</li><li>After opening MPLAB, close any projects that are open on the left pane.</li><li>Ctrl+Shift+N to open the new project dialog box. Select Standalone Project then Click Next.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/master-new-project.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/master-new-project-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-new-project-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-new-project-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-new-project-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-new-project-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-new-project-2xl.jpg 1600w" alt="MPLAB Create Project" width="902" height="629"></figure></li><li>In the Select Device dialog, select "16-bit DSCs (dsPIC33)" as the Family, "dsPIC33CH128MP508" as the Device and "Starter Kits (PKOB)-SN:BUR182571251" as the Tool. Note, there is a DM330028-2 version of the Curiosity board so the device and tool will be different. Please refer to its user guide or check the actual part number of the dsPIC IC that is mounted on the board.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/MPLAB-select-device.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB-select-device-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB-select-device-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB-select-device-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB-select-device-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB-select-device-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB-select-device-2xl.jpg 1600w" alt="MPLAB new project - select device" width="902" height="627"></figure></li><li>In the next dialog, select Compiler XC16 (v1.70) then click next. You may have a newer version installed.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/select-compiler.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/select-compiler-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-compiler-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-compiler-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-compiler-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-compiler-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-compiler-2xl.jpg 1600w" alt="MPLAB select compiler" width="911" height="632"></figure></li><li>Name the project as "master". I save it to folder "hysteretic". Click Finish.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/project-name-and-folder.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/project-name-and-folder-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-name-and-folder-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-name-and-folder-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-name-and-folder-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-name-and-folder-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-name-and-folder-2xl.jpg 1600w" alt="MPLAB Select Project Name and Folder" width="955" height="633"></figure></li></ol><h2>SLAVE CORE GENERATION</h2><ol><li>Ctrl+Shift+N to open again the new project dialog box. Select Standalone Project then click Next.</li><li>Again, your Curiosity board may have a different device name but take note of the last two characters ("S1") for the device which means that it is the slave core. Select device dsPIC33CH128MP508S1 and Starter Kits (PKOB)-SN:BUR182571251 then click Next.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/select-slave-device.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/select-slave-device-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-slave-device-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-slave-device-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-slave-device-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-slave-device-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/select-slave-device-2xl.jpg 1600w" alt="MPLAB Select slave device" width="910" height="631"></figure></li><li>Select compiler XC16 (v1.70) then click Next.</li><li>Name the project as "slave" and use the same project location with the master core. Click Finish.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/slave-project-name-and-folder.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-name-and-folder-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-name-and-folder-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-name-and-folder-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-name-and-folder-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-name-and-folder-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-name-and-folder-2xl.jpg 1600w" alt="MPLAB slave project name and folder" width="956" height="636"></figure></li></ol><h2>MASTER CORE CONFIGURATION</h2><ol><li>On the Projects Pane, right click on master and select "Set as Main Project".<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/MPLAB_Set_main_project.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_Set_main_project-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_Set_main_project-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_Set_main_project-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_Set_main_project-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_Set_main_project-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_Set_main_project-2xl.jpg 1600w" alt="MPLAB master set as main project" width="412" height="671"></figure></li><li>Click the MCC button<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/mcc-button.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/mcc-button-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/mcc-button-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/mcc-button-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/mcc-button-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/mcc-button-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/mcc-button-2xl.jpg 1600w" alt="MCC button" width="45" height="42"></figure>on the toolbox and wait until the MCC program has loaded. It takes a while to load on my PC. A master.mc3 file will also be discreetly created in the root of the master project folder (..\master.x\master.mc3).</li><li>In the device resources pane, click the "+" of the SLAVE CORE.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/device-resources-slave-core.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-slave-core-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-slave-core-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-slave-core-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-slave-core-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-slave-core-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-slave-core-2xl.jpg 1600w" alt="MCC Device Resources Slave Core" width="247" height="317"></figure><br>After clicking the "+", the slave core should appear on the project resources pane.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/project-resources-slave-core.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/project-resources-slave-core-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-resources-slave-core-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-resources-slave-core-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-resources-slave-core-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-resources-slave-core-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/project-resources-slave-core-2xl.jpg 1600w" alt="MCC Project Resources  - Slave Core" width="246" height="251"></figure></li><li>In the Slave Core Pane, name the Slave as "slave". Enable Protocol A and Protocol B. Set Protocol A Direction as M-&gt;S.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/master-slave-core-configuration.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-core-configuration-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-core-configuration-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-core-configuration-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-core-configuration-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-core-configuration-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-core-configuration-2xl.jpg 1600w" alt="MCC master slave peripheral configuration" width="807" height="517"></figure>In the Slave Clock settings of the Slave Core pane, set Clock Output Pin Configuration as "OSC2 is general purpose digital I/O pin".<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/master-slave-peripheral-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-peripheral-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-peripheral-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-peripheral-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-peripheral-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-peripheral-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-slave-peripheral-2-2xl.jpg 1600w" alt="slave peripheral clock pin" width="587" height="441"></figure></li><li>In the Pin Manager Pane, set RB2, RC3, RC6 and RC14 as owned by the Slave Core. RB2 will be used as monitor for an analog signal from DAC inside the dsPIC. RC3 will be used as monitor for the output of the first comparator inside the dsPIC. RC6 will be used as monitor for the output of the second comparator inside the dsPIC. RC14 will be used as the output of the SR logic and used to drive the buck MOSFET Q6.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/master-pin-manager.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/master-pin-manager-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-pin-manager-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-pin-manager-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-pin-manager-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-pin-manager-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-pin-manager-2xl.jpg 1600w" alt="MPLAB master slave peripheral ownership" width="1262" height="473"></figure></li><li>In the System Module Pane, set clock output pin as "OSC2 is general purpose digital I/O pin".<h2><br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/master-clock-output-pin-configuration.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/master-clock-output-pin-configuration-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-clock-output-pin-configuration-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-clock-output-pin-configuration-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-clock-output-pin-configuration-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-clock-output-pin-configuration-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/master-clock-output-pin-configuration-2xl.jpg 1600w" alt="MCC master clock output pin configuration" width="640" height="247"></figure></h2></li><li><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Go back to the Slave Core Pane and click Save Master Settings button. A file named master_config.mc3 will be discreetly generated on the root of the master folder after you click the Save Master Settings button.</span></li><li>Lastly for the master configuration, click the Generate button on the Project Resources pane. If there are warnings, review first the Notifications [MCC] pane.</li><li>After confirmation on the generate configuration, you should see a Generation complete on the text output window. After that, close the configuration by clicking the MCC toolbar button.</li></ol><h2>SLAVE CORE CONFIGURATION</h2><ol><li>On the Projects Pane, right click on the slave project and select as Main Project.</li><li>Click on the MCC button on the toolbar. Wait until the MCC application is completely loaded. A file named slave.mc3 will also be discreetly generated on the root of the slave project folder (..\slave.x\slave.mc3).</li><li>Go to the Master Core Pane then click Load Slave Settings from Master Configuration button.</li><li>In the Load Master Settings dialog box, browse to the master core folder and open the master_config.mc3 file.</li><li>In the System Module tab, tick PLL enable, select 1:100 as Feedback, select FVCO/2 as VCO Divider and select FVCO/2 as AVCO Divider. These settings are needed for the comparator to operate.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/system-module-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/system-module-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/system-module-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/system-module-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/system-module-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/system-module-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/system-module-2-2xl.jpg 1600w" alt="MCC Slave System module" width="510" height="703"></figure></li><li>In the Device Resources window, click on the "+" of the ADC1 to transfer it to the Project Resources.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/device-resources-adc1.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-adc1-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-adc1-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-adc1-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-adc1-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-adc1-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-adc1-2xl.jpg 1600w" alt="MCC device resources - ADC1" width="354" height="242"></figure></li><li>In the ADC1 tab, tick Enable of Core1. Select S1ANA1 as the Core Channel of Core1. S1ANA1 is connected to the RC1_VOUTFB (output voltage sense) of the dsPIC IC. Select Common Software Trigger as the Trigger Source of Core1. Tick Interrupt of Core1.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/adc1-settings.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/adc1-settings-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/adc1-settings-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/adc1-settings-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/adc1-settings-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/adc1-settings-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/adc1-settings-2xl.jpg 1600w" alt="MCC Slave ADC configuration" width="854" height="423"></figure></li><li>In the Device Resources pane, click the "+" of the TMR1 to move the timer peripheral to the Project Resources.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/device-resources-tmr1.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-tmr1-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-tmr1-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-tmr1-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-tmr1-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-tmr1-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-tmr1-2xl.jpg 1600w" alt="MCC Device Resources timer" width="356" height="230"></figure></li><li>In the TMR1 tab, type 25 us on the Timer Period and tick the Enable Timer Interrupt. This timer will be used to call the program that will trigger the ADC peripheral that we previously configured.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/TMR1-settings.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/TMR1-settings-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/TMR1-settings-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/TMR1-settings-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/TMR1-settings-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/TMR1-settings-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/TMR1-settings-2xl.jpg 1600w" alt="MCC TMR1 peripheral settings" width="752" height="423"></figure></li><li>In the Device Resources pane, click the "+" of the CMP1 to move the CMP1 peripheral to the Project Resources.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/device-resources-cmp1.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp1-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp1-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp1-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp1-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp1-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp1-2xl.jpg 1600w" alt="MCC Device resources CMP1" width="358" height="243"></figure></li><li>In the CMP1 tab, tick the Enable Comparator, type 400 MHz on the Clock Frequency and tick the Enable DAC output. Note that the Non-Inverting Input default is set to S1CMP1A where RA3_ISENSEH (high side current sense) pin is connected. Ticking the Enable DAC output means that the DAC output that is connected to the inverting input of the comparator will also be connected to DACOUT pin (RB2). We are doing this to monitor the analog output of the DAC.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/CMP1-settings.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/CMP1-settings-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/CMP1-settings-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/CMP1-settings-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/CMP1-settings-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/CMP1-settings-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/CMP1-settings-2xl.jpg 1600w" alt="MCC CMP1 settings" width="589" height="573"></figure></li><li>  In the Device Resources pane, click on the "+" of the PGA2 (programmable gain amplifier) to move the PGA to the Project Resources. We are selecting PGA2 because it is the peripheral connected to the RD14_ISENSEL (low side current sense) pin of the dsPIC which needs to be amplified with -8 gain.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/device-resources-pga2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-pga2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-pga2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-pga2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-pga2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-pga2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-pga2-2xl.jpg 1600w" alt="MCC device resources PGA" width="359" height="244"></figure></li><li>In the PGA2 tab, change the Gain to 8x, Negative Input to S1PGA2N2 and Positive Input to Ground. S1PGA2N2 is the one that is connected to RD14_ISENSEL pin of the dsPIC. Note that we connect the sense to the negative input and ground to the positive input of the amplifier to have a negative gain.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/pga2-settings.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/pga2-settings-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/pga2-settings-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/pga2-settings-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/pga2-settings-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/pga2-settings-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/pga2-settings-2xl.jpg 1600w" alt="MCC PGA settings" width="481" height="268"></figure></li><li>In the Device Resources pane, click on the "+" of the CMP2 to transfer it to the Project Resources.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/device-resources-cmp2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-cmp2-2xl.jpg 1600w" alt="MCC Device Resources  - CMP2" width="364" height="245"></figure></li><li>In the CMP2 tab, tick the Enable Comparator, type 400 MHz on the Clock Frequency, select SPGA2 Output as the Non-Inverting Input, tick Inverted and tick Enable Digital Filter.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/cmp2-savings.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/cmp2-savings-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/cmp2-savings-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/cmp2-savings-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/cmp2-savings-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/cmp2-savings-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/cmp2-savings-2xl.jpg 1600w" alt="MCC CMP2 configuration" width="589" height="571"></figure></li><li>In the Device Resources pane, click the "+" of the CLC1 (Configurable Logic Cell) to transfer it to the Project Resources.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/device-resources-clc1.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-clc1-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-clc1-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-clc1-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-clc1-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-clc1-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/device-resources-clc1-2xl.jpg 1600w" alt="MCC Device Resources - CLC1" width="361" height="242"></figure></li><li>In the CLC1 tab, tick the Enable CLC Output, select SR latch as Mode, select Slave CMP1 output and Slave CMP2 output as inputs of the CLC, Connect Slave CMP1 output to Gate 3, Connect Slave CMP2 to Gate 2 and set the CLCOUT as inverted. The CLCOUT will be configured after to connect to RC14_S1PWM7H pin to drive the buck MOSFET Q6. It is needed to invert the output because Q6 is a p-type MOSFET that need negative gate-source voltage to turn on.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/clc1-settings.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/clc1-settings-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/clc1-settings-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/clc1-settings-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/clc1-settings-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/clc1-settings-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/clc1-settings-2xl.jpg 1600w" alt="MCC CLC1 configuration" width="1038" height="649"></figure></li><li>In the Pin Manager Tab, connect S1CLC1OUT to RC14, S1CMP1 to RC3 and S1CMP2 to RC6.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/slave-pin-manager.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/slave-pin-manager-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-pin-manager-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-pin-manager-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-pin-manager-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-pin-manager-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-pin-manager-2xl.jpg 1600w" alt="MCC Slave pin manager" width="866" height="445"></figure></li><li>In the Pin Module Tab, type RC1_VOUTFB in the Custom Name of RC1.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/pin-module.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/pin-module-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/pin-module-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/pin-module-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/pin-module-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/pin-module-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/pin-module-2xl.jpg 1600w" alt="MCC Slave Pin Module" width="504" height="340"></figure></li><li>In the Notifications [MCC] tab, review the messages. I usually will have the same as below.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/MCC-slave-notifications.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/MCC-slave-notifications-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/MCC-slave-notifications-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/MCC-slave-notifications-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/MCC-slave-notifications-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/MCC-slave-notifications-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/MCC-slave-notifications-2xl.jpg 1600w" alt="MCC Slave notification " width="919" height="334"></figure></li><li>In the Project Resources pane, click Generate button. Click Yes to disregard the warnings and proceed generating the source files. Wait until a "Generation complete" text appears on the MPLAB Code Configurator prompt window.</li><li>Close the code configurator by clicking the MCC toolbar button.</li></ol><h2>ADD SLAVE TO MASTER BUILD</h2><ol><li>Right click on the Secondaries folder of master project and click Add Secondary Project...<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/MPLAB_add_secondary_project.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_add_secondary_project-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_add_secondary_project-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_add_secondary_project-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_add_secondary_project-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_add_secondary_project-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/MPLAB_add_secondary_project-2xl.jpg 1600w" alt="MPLAB add slave to compile" width="387" height="375"></figure></li><li>In the Add Secondary Project dialog box, find and select the slave.X folder and click Add.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/Add-secondary-project.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/Add-secondary-project-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/Add-secondary-project-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/Add-secondary-project-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/Add-secondary-project-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/Add-secondary-project-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/Add-secondary-project-2xl.jpg 1600w" alt="MPLAB Add secondary project dialog box" width="898" height="423"></figure></li><li>Right click again on the Secondaries Folder and select Properties. Tick the Build box of the properties dialog windows then click OK.</li></ol><h2>MAIN PROGRAM</h2><ol><li>Open the slave project's main.c file.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/slave-project-main.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-main-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-main-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-main-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-main-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-main-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/slave-project-main-2xl.jpg 1600w" alt="MPLAB Slave project main.c" width="294" height="261"></figure></li><li>Replace the main.c file contents with below code. The program has two interrupt handler functions, MyTimer and PID. MyTimer is called every 25us as we configured it on the MCC previously. MyTimer will just enable the software common trigger ( SWCTRG) bit of ADC1. When SWCTRG is enabled, the PID function will be called then the ADC1 will automatically disable back the SWCTRG. The last line of the PID function changes the value of DAC1DATH. DAC1DATH value is the one that is converted into analog that is fed to the CMP1 - input.<br><code>#include "mcc_generated_files/system.h"<br>#include "mcc_generated_files/pin_manager.h"<br>#include "mcc_generated_files/adc1.h"<br>#include "mcc_generated_files/tmr1.h"<br><br>/*PID function and variable definitions*/<br>void PID(void);<br>void MyTimer(void);<br>volatile int16_t n16_integrator_memory;<br>volatile int16_t n16_reference;<br>int16_t n16_error;<br>int16_t n16_proportional;<br><br>#define target_voltage  3.3<br>#define reference       666.7*target_voltage + 70<br>#define p_gain          0.5<br>#define i_gain          0.1<br><br>int main(void)<br>{<br>    // initialize the device<br>    SYSTEM_Initialize();<br>    //Initialize PID variables<br>    n16_integrator_memory = 0;<br>    n16_reference = (int16_t) reference;<br>    DAC2DATH = 20;<br>    //Assign Interrupt Handlers<br>    ADC1_SetRC1_VOUTFBInterruptHandler(PID);<br>    TMR1_SetInterruptHandler(MyTimer);<br>    while (1)<br>    {<br>        // Add your application code<br>    }<br>    return 1; <br>}<br>void MyTimer(void)<br>{<br>    ADCON3Lbits.SWCTRG = 1;<br>}<br>void PID(void)<br>{<br>    n16_error = n16_reference - ADCBUF1;<br>    n16_integrator_memory = n16_integrator_memory + i_gain*n16_error;<br>    n16_proportional = p_gain*n16_error;<br>    DAC1DATH = n16_integrator_memory + n16_proportional+290;<br>}</code></li><li>Right click on the master project and select Set as Main Project.</li><li>Open the master projects main.c file.</li><li>Paste the following codes after the line with SYSTEM_Initialize();<br> <code>SLAVE1_Program();<br>  SLAVE1_Start();</code></li><li>Click the Make and Program Device Main Project button<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/make-and-program-device-main-project-button.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/make-and-program-device-main-project-button-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/make-and-program-device-main-project-button-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/make-and-program-device-main-project-button-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/make-and-program-device-main-project-button-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/make-and-program-device-main-project-button-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/make-and-program-device-main-project-button-2xl.jpg 1600w" alt="MPLAB make and program device main project" width="34" height="29"></figure>. Wait until Programming/Verify complete is prompted in the text output window.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/mplab-window-programming-verify-complete.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/mplab-window-programming-verify-complete-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/mplab-window-programming-verify-complete-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/mplab-window-programming-verify-complete-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/mplab-window-programming-verify-complete-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/mplab-window-programming-verify-complete-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/mplab-window-programming-verify-complete-2xl.jpg 1600w" alt="MPLAB programming/verify complete" width="437" height="316"></figure></li></ol><h2>RESULT</h2><ol><li>Below waveforms are 3.3V Vout (Orange), Buck MOSFET Q6 drive (Purple) which is measured from pin RC14, CMP1 (Blue 2nd from the bottom) which is measured from pin RC3 and CMP2 (Blue, most bottom) which is measured from pin RC6. Duty is 62% while Frequency is 462kHz. Actually, by ignoring the diode drop and other losses we can confirm the -duty by the formula Vout/Vin =  66% which is near the measured -duty. -Duty is measured here because of the reverse gate voltage requirement of Q6. <br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/result-Vout-Q6-CMP1-CMP2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/result-Vout-Q6-CMP1-CMP2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-Vout-Q6-CMP1-CMP2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-Vout-Q6-CMP1-CMP2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-Vout-Q6-CMP1-CMP2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-Vout-Q6-CMP1-CMP2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-Vout-Q6-CMP1-CMP2-2xl.jpg 1600w" alt="Scopy " width="1096" height="582"></figure></li><li>I want to measure the current sense signal on pin RA3 but I realize my scope probe impedance effect is significant for the circuit to handle. When I connect the probe to RA3, the CMP1 output goes abnormal so first I am measuring the voltage on the DAC of CMP1 to know what peak voltage on RA3 before Q6 turns off. Below orange waveform is the DAC waveform and has a mean value of 323mV.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/result-CMP1-DAC-Q6-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/result-CMP1-DAC-Q6-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-CMP1-DAC-Q6-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-CMP1-DAC-Q6-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-CMP1-DAC-Q6-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-CMP1-DAC-Q6-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-CMP1-DAC-Q6-2-2xl.jpg 1600w" alt="scopy" width="1053" height="568"></figure></li><li>Instead of measuring directly the high side current sense RA3 signal, we can utilize another built-in PGA inside the dsPIC to measure it and then we measure the output of the PGA.</li><li>Right click on the slave project and set it as the Main Project.</li><li>Click the MCC button on the toolbar menu and wait the MCC application to load completely.</li><li>On the Master Core tab, click the Load Slave Settings from Master Configuration button and find/select the master_config.mc3 file.</li><li>Add the PGA1 from the Device Resources Pane to the Project Resources.</li><li>Click the Generate button on the Project Resources pane then click Yes on the MCC Confirmation warnings dialog box.</li><li>Close the MCC application by clicking the MCC button on the toolbar menu.</li><li>On the slave project's main.c file, add the following code after the line with TMR1_SetInterruptHandler(MyTimer); . <br><code>DAC1CONLbits.DACOEN = 0;<br> PGA1CONbits.PGAOEN = 1;</code><br>These two lines means that the PGA1 is connected to RB2 instead of the CMP1's DAC.</li><li>Right click on master project and select Set as Main Project.</li><li>Click Make and Program Device Main Project button on the toolbar menu. Wait until Programming/Verify Complete is prompted in the output text window.</li><li>The orange waveform below is the voltage on RB2 which is now the PGA1 output and is the voltage measured on RA3 (high side current sense) multiplied by 4. The peak current is about 1.36V. 1.36V/4 = 340mV which is has similar value with the CMP1 DAC output.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/result-PGA1-Q6.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA1-Q6-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA1-Q6-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA1-Q6-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA1-Q6-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA1-Q6-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA1-Q6-2xl.jpg 1600w" alt="scopy" width="1012" height="581"></figure></li><li>Next we try what waveform we can see on the low side current sense. Since this is also a very small level signal and I do not have a good low impedance probe, we will measure the PGA output instead of measuring directly the signal at pin RD14.</li><li>On the slave project's main.c file, change PGA1CONbits.PGAOEN = 1; to <code>PGA<strong>2</strong>CONbits.PGAOEN = 1;</code>.</li><li>Click Make and Program Device Main Project button on the toolbar menu. Wait until Programming/Verify Complete is prompted in the output text window.</li><li>The orange waveform below is now the PGA2 output which is the voltage measured on RD14 (low side current sense) multiplied by 8. I changed the voltage per division to make the signal larger on the screen. The peak voltage is only 130mV. 130mV/8 = 16.25mV is the peak voltage on RD14 which is too small if we use an ordinary passive probe.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/11/result-PGA2-Q6-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA2-Q6-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA2-Q6-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA2-Q6-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA2-Q6-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA2-Q6-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/11/responsive/result-PGA2-Q6-2-2xl.jpg 1600w" alt="scopy" width="1015" height="567"></figure></li></ol><p> </p><p> </p><p> </p><p><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2158060120252492" crossorigin="anonymous"></script></p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on November 28, 2021</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio box"><img class="u-author__avatar" src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="lazy" alt="Andrew Mosqueda"><div><h4 class="h6"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/" class="post__nav__link" rel="prev"><div class="u-small">Previous Post<h5>LTspice simulation of hysteretic current control for buck converter</h5></div></a></div></nav><div class="post__related box"><h3 class="box__title">Related posts</h3><div class="post__related-wrap"><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/" class="inverse">Simulation of the PCI-Current Limit Logic of dsPIC33CH</a></h4><time datetime="2021-09-26T17:12" class="u-small">September 26, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/high-side-current-sense-circuit-simulation/" class="inverse">High Side Current Sense Circuit Simulation</a></h4><time datetime="2021-09-25T08:56" class="u-small">September 25, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/current-mode/" class="inverse">5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</a></h4><time datetime="2021-09-11T21:52" class="u-small">September 11, 2021</time></figcaption></figure></div></div></footer></article><div class="comments box"><h3 class="box__title">Comments</h3><div id="disqus_thread"></div><script>var disqus_config = function () {
                    this.page.url = 'https://andrewmosqueda.github.io/hysteretic-current-mode-buck-converter-for-dspic33/';
            		this.page.identifier = '11';
                };
            
                var disqus_loaded = false;
            
                function publiiLoadDisqus() {
                    if(disqus_loaded) {
                        return false;
                    }
            
                    var top = document.getElementById('disqus_thread').offsetTop;
            
                    if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                        disqus_loaded = true;
            
                        (function () {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    }
                }
            
                publiiLoadDisqus();
            
                window.onscroll = function() {
                    publiiLoadDisqus();
                };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></main><div class="sidebar"><section class="box featured"><h3 class="box__title">Featured</h3><ul class="featured__container"><li class="featured__item"><div><a href="https://andrewmosqueda.github.io/current-mode/" class="featured__title">5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</a> <time class="u-small" datetime="2021-09-11T21:52">September 11, 2021</time></div></li></ul></section><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__image-link"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" alt="Andrew Mosqueda"></a><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__title">Andrew Mosqueda</a> <span class="u-small">Post: 11</span></div></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a><nav><ul class="footer__nav"></ul></nav><div class="footer__follow"><a href="https://www.facebook.com/andrew.mosqueda" aria-label="Facebook"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://www.linkedin.com/in/alex-andrew-mosqueda-31197876/" aria-label="LinkedIn"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#linkedin"/></svg> </a><a href="https://www.youtube.com/channel/UCHcJ7jRLmntRZrI8h41y3Yg" aria-label="Youtube"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#youtube"/></svg></a></div><div class="footer__copyright"><p>andrewgs7311@gmail.com</p></div></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://andrewmosqueda.github.io/assets/js/scripts.min.js?v=3dc768003cc6d66c9e7bf0904e71d3e8"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>