<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>LTspice simulation of hysteretic current control for buck converter - Andrew Mosqueda</title><meta name="description" content=" In this article, LTspice simulation of a 5V to 3.3V buck converter using hysteretic current control is presented. The circuit simulated here is the power circuit included in the DM330028 dsPIC33CH Curiosity Developement Board. The control method is an emulation of components and programming&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/"><link rel="alternate" type="application/atom+xml" href="https://andrewmosqueda.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://andrewmosqueda.github.io/feed.json"><meta property="og:title" content="LTspice simulation of hysteretic current control for buck converter"><meta property="og:site_name" content="Andrew Mosqueda - Andrew Mosqueda"><meta property="og:description" content=" In this article, LTspice simulation of a 5V to 3.3V buck converter using hysteretic current control is presented. The circuit simulated here is the power circuit included in the DM330028 dsPIC33CH Curiosity Developement Board. The control method is an emulation of components and programming&hellip;"><meta property="og:url" content="https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/"><meta property="og:type" content="article"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--post-entry-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://andrewmosqueda.github.io/assets/css/style.css?v=eacb492672ba3c1641d647982de266ba"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/"},"headline":"LTspice simulation of hysteretic current control for buck converter","datePublished":"2021-11-20T22:27","dateModified":"2021-11-28T16:47","description":" In this article, LTspice simulation of a 5V to 3.3V buck converter using hysteretic current control is presented. The circuit simulated here is the power circuit included in the DM330028 dsPIC33CH Curiosity Developement Board. The control method is an emulation of components and programming&hellip;","author":{"@type":"Person","name":"Andrew Mosqueda"},"publisher":{"@type":"Organization","name":"Andrew Mosqueda"}}</script></head><body><header class="topbar" id="js-header"><div class="topbar__inner"><a class="logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2022-02-01T15:22">February 1, 2022</time></div><div class="infobar__search"><form action="https://andrewmosqueda.github.io/search.html"><input type="search" name="q" placeholder="search..." aria-label="Search input"> <button type="submit" aria-label="Submit"><svg role="presentation" focusable="false" width="15px" height="14px"><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#search"/></svg></button></form></div></div><main class="main"><article class="post"><header class="u-header post__header"><h1>LTspice simulation of hysteretic current control for buck converter</h1><div class="u-header__meta u-small"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="eager" class="u-header__avatar" alt="Andrew Mosqueda"><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a> <time datetime="2021-11-20T22:27">November 20, 2021</time></div></div></header><div class="post__entry u-inner"><p><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2158060120252492" crossorigin="anonymous"></script></p><h2>INTRODUCTION</h2><p>In this article, LTspice simulation of a 5V to 3.3V buck converter using hysteretic current control is presented. The circuit simulated here is the power circuit included in the DM330028 dsPIC33CH Curiosity Developement Board. The control method is an emulation of components and programming of dsPIC33CH. The aim of the simulation is to have an insight on how to configure and program the dsPIC33CH for hysteretic current control.</p><h2>LTSPICE SCHEMATIC</h2><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/10/LTspice-simulation-5.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/10/responsive/LTspice-simulation-5-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/10/responsive/LTspice-simulation-5-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/10/responsive/LTspice-simulation-5-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/10/responsive/LTspice-simulation-5-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/10/responsive/LTspice-simulation-5-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/10/responsive/LTspice-simulation-5-2xl.jpg 1600w" alt="Hysteretic current mode converter LTspice" width="867" height="877"></figure><h5>POWER CIRCUIT</h5><p>In hysteretic mode, the MOSFET Q6 is switch on until a predetermined peak current is reached. During turn off, the controller will turn on again the MOSFET when the current flowing on the mosfet returns to 0 ampere. The power circuit output level is inherently inversely proportional to the switching frequency of MOSFET Q6 while the duty cycle does not change much. All the components on the power circuit except the Rload resistor can be found on FIGURE A-3 of the DS50002762A document from microchip. I put 100Ω resistor as Rload because it is the one I use as actual load for the 3.3V output. Note also that MOSFET Q6 is a P-Type so a low-level voltage is needed at the gate to turn it on.</p><h5>HIGH SIDE CURRENT SENSE</h5><p>This circuit is used for sensing the current on MOSFET Q6. The output of the high side current sense circuit is fed to the analog comparator CMP1. Below waveform ra3_isenseh is the output of this circuit and compared to the gate drive rc14 waveform. Note that when Q6 is turned off, R63_92_93 is used as low side current sensing circuit instead. All the components on the high side current circuit can also be found on FIGURE A-3 of the DS50002762A document from microchip. The operation of the circuit is also explained in the same document. </p><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/10/high-side-current-sense-vs-mosfet-drive.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/10/responsive/high-side-current-sense-vs-mosfet-drive-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/10/responsive/high-side-current-sense-vs-mosfet-drive-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/10/responsive/high-side-current-sense-vs-mosfet-drive-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/10/responsive/high-side-current-sense-vs-mosfet-drive-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/10/responsive/high-side-current-sense-vs-mosfet-drive-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/10/responsive/high-side-current-sense-vs-mosfet-drive-2xl.jpg 1600w" alt="high side current sense vs mosfet gate drive" width="914" height="884"></figure><h5>ADC1</h5><p> This ADC module is the one used for sensing the output voltage of the power circuit. The output of the ADC is a digital representation of the sensed output voltage and is fed to or is used by the PID program (C CODE IN MPLAB). This circuit is a mathematical equivalent of the ADC module of the dsPIC33CH. I derived the equation based from my experiment.</p><h5>CMP1</h5><p>The CMP1 module compares the MOSFET Q6 current (from high side current sense circuit) to the peak current limit PGDC that is calculated by the PID program (C CODE in MPLAB). In MPLAB, i will select 400MHz as the clock frequency of the comparator so I put tau=7.5n (consider also the effect of pulse stretcher). Setting tau=7.5n also will make the simulation faster. The output of the CMP1 is used as terminator for the CLC1 module. Below are the terminator waveform and comparator outputs ra3_isenseh and dac.</p><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/10/terminator.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/10/responsive/terminator-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/10/responsive/terminator-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/10/responsive/terminator-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/10/responsive/terminator-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/10/responsive/terminator-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/10/responsive/terminator-2xl.jpg 1600w" alt="comparator output" width="899" height="878"></figure><h5>C CODE IN MPLAB</h5><p>LTspice has no c code so this circuit is just a representation of the PID c code that I will use in MPLAB. Below is the MPLAB PID c code that I usually use. The LTspice element B4 is used to calculate the error which is the difference of the reference and the output of the ADC1. The 2nd line in the PID code below is done by my own LTspice integrator circuit. The integrator circuit operation can be found in this link <a href="https://andrewmosqueda.github.io/implementing-a-discrete-integrator-in-ltspice/" target="_blank" rel="noopener noreferrer"></a> <a href="https://andrewmosqueda.github.io/implementing-a-discrete-integrator-in-ltspice/" target="_blank" rel="noopener noreferrer">LTspice integrator.</a> The LTspice element B7 is used to calculate the proportional portion of the PID. The output of the PID is then fed to the DAC1DATH register of ADC1.</p><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/10/pid-code-3.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/10/responsive/pid-code-3-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/10/responsive/pid-code-3-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/10/responsive/pid-code-3-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/10/responsive/pid-code-3-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/10/responsive/pid-code-3-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/10/responsive/pid-code-3-2xl.jpg 1600w" alt="PID c code in MPLAB" width="567" height="125"></figure><h5>PGA2</h5><p>The low side current sense resistor R63_92_93 of the power circuit has a negative level with respect to the current flow on D2. In order to become positive level, the output of the current sense is fed into the negative input of the PGA (programmable gain amplifier). The PGA gain is set to 8 as recommended in the DS50002762A document. The output of the PGA is fed into another comparator CMP2. </p><h5>CMP2</h5><p>This comparator outputs high when the output of the low side current sense becomes 0. The output of this comparator is used to set high the CLC1 circuit. Below is the start waveform and the input to the comparator (blue waveform). The settings of the this comparator is the same with CMP1 except that its negative input is fixed at 0.</p><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/10/start.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/10/responsive/start-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/10/responsive/start-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/10/responsive/start-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/10/responsive/start-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/10/responsive/start-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/10/responsive/start-2xl.jpg 1600w" alt="comparator output" width="940" height="880"></figure><h5>CLC1</h5><p>This circuit is a representation of the dsPIC33's CLC (configurable Logic Cell) configured as an SR flip-flop. This circuit outputs low when START input becomes high and outputs high when Terminator input becomes high.</p><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/10/CLC1-output.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/10/responsive/CLC1-output-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/10/responsive/CLC1-output-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/10/responsive/CLC1-output-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/10/responsive/CLC1-output-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/10/responsive/CLC1-output-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/10/responsive/CLC1-output-2xl.jpg 1600w" alt="SR flip flop operation" width="941" height="878"></figure><h2>LTSPICE FILES</h2><p>Download LTspice files here: <a href="https://andrewmosqueda.github.io/media/files/Hysteretic Current Mode Converter.zip" target="_blank" rel="noopener noreferrer">LTspice Hysteretic Current Mode Converter</a></p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on November 28, 2021</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio box"><img class="u-author__avatar" src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="lazy" alt="Andrew Mosqueda"><div><h4 class="h6"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://andrewmosqueda.github.io/using-the-slope-compensation-for-the-current-mode-control/" class="post__nav__link" rel="prev"><div class="u-small">Previous Post<h5>Using the slope compensation for the current mode control</h5></div></a></div><div class="post__nav__next"><a href="https://andrewmosqueda.github.io/hysteretic-current-mode-buck-converter-for-dspic33/" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>Hysteretic Current Mode Buck Converter with dsPIC33</h5></div></a></div></nav><div class="post__related box"><h3 class="box__title">Related posts</h3><div class="post__related-wrap"><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/high-side-current-sense-circuit-simulation/" class="inverse">High Side Current Sense Circuit Simulation</a></h4><time datetime="2021-09-25T08:56" class="u-small">September 25, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/current-mode/" class="inverse">5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</a></h4><time datetime="2021-09-11T21:52" class="u-small">September 11, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/implementing-5v-to-12v-pwm-boos-converter-in-the-dspic33ch-curiosity-development-board/" class="inverse">Implementing 5V to 12V PWM Boost Converter in the DSPIC33CH Curiosity Development Board</a></h4><time datetime="2021-08-17T20:18" class="u-small">August 17, 2021</time></figcaption></figure></div></div></footer></article><div class="comments box"><h3 class="box__title">Comments</h3><div id="disqus_thread"></div><script>var disqus_config = function () {
                    this.page.url = 'https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/';
            		this.page.identifier = '10';
                };
            
                var disqus_loaded = false;
            
                function publiiLoadDisqus() {
                    if(disqus_loaded) {
                        return false;
                    }
            
                    var top = document.getElementById('disqus_thread').offsetTop;
            
                    if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                        disqus_loaded = true;
            
                        (function () {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    }
                }
            
                publiiLoadDisqus();
            
                window.onscroll = function() {
                    publiiLoadDisqus();
                };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></main><div class="sidebar"><section class="box featured"><h3 class="box__title">Featured</h3><ul class="featured__container"><li class="featured__item"><div><a href="https://andrewmosqueda.github.io/current-mode/" class="featured__title">5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</a> <time class="u-small" datetime="2021-09-11T21:52">September 11, 2021</time></div></li></ul></section><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__image-link"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" alt="Andrew Mosqueda"></a><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__title">Andrew Mosqueda</a> <span class="u-small">Post: 12</span></div></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a><nav><ul class="footer__nav"></ul></nav><div class="footer__follow"><a href="https://www.facebook.com/andrew.mosqueda" aria-label="Facebook"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://www.linkedin.com/in/alex-andrew-mosqueda-31197876/" aria-label="LinkedIn"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#linkedin"/></svg> </a><a href="https://www.youtube.com/channel/UCHcJ7jRLmntRZrI8h41y3Yg" aria-label="Youtube"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#youtube"/></svg></a></div><div class="footer__copyright"><p>andrewgs7311@gmail.com</p></div></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://andrewmosqueda.github.io/assets/js/scripts.min.js?v=3dc768003cc6d66c9e7bf0904e71d3e8"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>