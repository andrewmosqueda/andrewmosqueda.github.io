Version 4
SHEET 1 1580 964
WIRE 832 -320 816 -320
WIRE 0 -288 -64 -288
WIRE 112 -288 80 -288
WIRE 272 -288 208 -288
WIRE 320 -288 272 -288
WIRE 448 -288 400 -288
WIRE 576 -288 512 -288
WIRE 656 -288 576 -288
WIRE 736 -288 656 -288
WIRE 816 -288 816 -320
WIRE 816 -288 736 -288
WIRE 896 -288 816 -288
WIRE 992 -288 896 -288
WIRE 1120 -288 992 -288
WIRE -64 -272 -64 -288
WIRE 1120 -272 1120 -288
WIRE 576 -256 576 -288
WIRE 656 -256 656 -288
WIRE 736 -256 736 -288
WIRE 816 -256 816 -288
WIRE 896 -256 896 -288
WIRE 992 -256 992 -288
WIRE 272 -240 272 -288
WIRE 128 -224 128 -240
WIRE -64 -176 -64 -192
WIRE 576 -160 576 -192
WIRE 656 -160 656 -192
WIRE 656 -160 576 -160
WIRE 736 -160 736 -192
WIRE 736 -160 656 -160
WIRE 816 -160 816 -192
WIRE 816 -160 736 -160
WIRE 896 -160 896 -192
WIRE 896 -160 816 -160
WIRE 992 -160 992 -192
WIRE 992 -160 896 -160
WIRE 1120 -160 1120 -192
WIRE 1120 -160 992 -160
WIRE 272 -144 272 -176
WIRE 736 -128 736 -160
WIRE 1040 176 320 176
WIRE 1072 256 320 256
WIRE 544 336 320 336
WIRE 736 336 704 336
WIRE 512 368 464 368
WIRE 544 368 512 368
WIRE 912 368 704 368
WIRE 464 384 464 368
WIRE 544 400 528 400
WIRE 528 432 528 400
WIRE 992 528 320 528
WIRE 1072 608 320 608
WIRE 1072 688 320 688
WIRE 1248 768 320 768
WIRE 1264 768 1248 768
WIRE 128 960 128 -144
WIRE 1248 960 1248 768
WIRE 1248 960 128 960
FLAG 528 432 0
FLAG -64 -176 0
FLAG 512 368 CLK
FLAG 736 336 0
FLAG 912 368 integrator_memory
IOPIN 912 368 Out
FLAG 240 688 0
FLAG 1072 688 RAMP
IOPIN 1072 688 Out
FLAG 1072 608 PGDC
IOPIN 1072 608 Out
FLAG 240 608 0
FLAG 464 464 0
FLAG 272 -144 0
FLAG 736 -128 0
FLAG 816 -320 Vout
FLAG 240 176 0
FLAG 1040 176 ADCBUF
IOPIN 1040 176 Out
FLAG 240 256 0
FLAG 1072 256 error
IOPIN 1072 256 Out
FLAG 240 336 0
FLAG 240 528 0
FLAG 992 528 proportional
IOPIN 992 528 Out
FLAG 240 768 0
FLAG 1264 768 PWM
IOPIN 1264 768 Out
SYMBOL integrator 624 368 R0
WINDOW 0 0 -56 Invisible 2
SYMATTR InstName U1
SYMBOL voltage -64 -288 R0
SYMATTR InstName V2
SYMATTR Value 5
SYMBOL pmos 208 -240 M270
WINDOW 0 64 43 VLeft 2
WINDOW 3 86 92 VLeft 2
SYMATTR InstName M1
SYMATTR Value IRF7210
SYMBOL voltage 336 688 R90
WINDOW 0 -16 -10 VRight 2
WINDOW 3 24 96 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V3
SYMATTR Value PULSE(0 {PGPER} 1n {(1/pwm_freq)-2n} 1n 1n {1/pwm_freq})
SYMBOL bv 336 608 R90
WINDOW 0 -32 56 Invisible 2
WINDOW 3 -31 -351 VTop 2
SYMATTR InstName B1
SYMATTR Value V=limit(PGPER-v(integrator_memory)-v(proportional),2048,0)
SYMBOL voltage 464 368 R0
WINDOW 0 -47 94 Bottom 2
WINDOW 3 32 56 Invisible 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V1
SYMATTR Value PULSE(0 1 1n 1n 1n {0.5/pwm_freq} {1/pwm_freq})
SYMBOL schottky 288 -176 R180
WINDOW 0 -43 25 Left 2
WINDOW 3 -78 0 Left 2
SYMATTR InstName D1
SYMATTR Value B520C
SYMATTR Description Diode
SYMATTR Type diode
SYMBOL ind 304 -272 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 5 56 VBottom 2
SYMATTR InstName L1
SYMATTR Value 33µH
SYMBOL cap 560 -256 R0
SYMATTR InstName C1
SYMATTR Value 10µF
SYMATTR SpiceLine Rser=10m
SYMBOL polcap 976 -256 R0
SYMATTR InstName C6
SYMATTR Value 100µF
SYMATTR SpiceLine Rser=60m
SYMBOL cap 640 -256 R0
SYMATTR InstName C2
SYMATTR Value 10µF
SYMATTR SpiceLine Rser=10m
SYMBOL cap 720 -256 R0
SYMATTR InstName C3
SYMATTR Value 10µF
SYMATTR SpiceLine Rser=10m
SYMBOL cap 800 -256 R0
SYMATTR InstName C4
SYMATTR Value 10µF
SYMATTR SpiceLine Rser=10m
SYMBOL cap 880 -256 R0
SYMATTR InstName C5
SYMATTR Value 10µF
SYMATTR SpiceLine Rser=10m
SYMBOL bv 336 176 R90
WINDOW 0 -32 56 Invisible 2
WINDOW 3 -33 -181 VTop 2
SYMATTR InstName B2
SYMATTR Value V=floor((666.7*v(Vout)) + 17.6)
SYMBOL bv 336 256 R90
WINDOW 0 -32 56 Invisible 2
WINDOW 3 -30 -165 VTop 2
SYMATTR InstName B3
SYMATTR Value V=floor(reference) - v(adcbuf)
SYMBOL bv 336 336 R90
WINDOW 0 -32 56 Invisible 2
WINDOW 3 -33 -91 VTop 2
SYMATTR InstName B4
SYMATTR Value V=i_gain*v(error)
SYMBOL bv 336 528 R90
WINDOW 0 -32 56 Invisible 2
WINDOW 3 -32 -133 VTop 2
SYMATTR InstName B5
SYMATTR Value V=floor(p_gain*v(error))
SYMBOL bv 336 768 R90
WINDOW 0 -32 56 Invisible 2
WINDOW 3 -33 -206 VTop 2
SYMATTR InstName B6
SYMATTR Value V=floor(if(v(RAMP)>v(PGDC), 0, 5))
SYMBOL res 112 -240 R0
SYMATTR InstName R1
SYMATTR Value 270
SYMBOL res 1104 -288 R0
SYMATTR InstName R2
SYMATTR Value 91
SYMBOL res 96 -304 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R59
SYMATTR Value 1
SYMBOL schottky 448 -272 R270
WINDOW 0 32 32 VTop 2
WINDOW 3 0 32 VBottom 2
SYMATTR InstName D2
SYMATTR Value B520C
SYMATTR Description Diode
SYMATTR Type diode
TEXT 232 56 Left 2 !.param pwm_freq=40k master_clk_freq=8meg
TEXT 232 96 Left 2 !.param PGPER=floor((master_clk_freq/pwm_freq)-1)
TEXT 232 -24 Left 2 !.param target_voltage=3.3 p_gain=0.1 i_gain=0.05
TEXT 232 16 Left 2 !.param reference=(666.7*target_voltage)+17.6
TEXT 376 -376 Left 2 !.ic v(vout)=3.3
TEXT 374 -404 Left 2 !.tran 0 {400/pwm_freq}
RECTANGLE Normal 1200 880 192 -64
