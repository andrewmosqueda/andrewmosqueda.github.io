<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Sensorless 6-Step Control for 3-Phase Brushless Motor Tutorial - Part 1 Stator PWM - Andrew Mosqueda</title><meta name="description" content="Introduction This tutorial is done with NUCLEO-F302R8 MCU board with X-NUCLEO-IHM07M1 expansion board and BR2804-1700KV-1 3-phase motor. The IDE used is STM32CubeIDE 1.8.0. The X-NUCLEO-IHM07M1 expansion board uses L6230 DMOS driver IC. The EN1, IN1, EN2, IN2, EN3 and IN3 pins of the IC are&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-1/"><link rel="alternate" type="application/atom+xml" href="https://andrewmosqueda.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://andrewmosqueda.github.io/feed.json"><meta property="og:title" content="Sensorless 6-Step Control for 3-Phase Brushless Motor Tutorial - Part 1 Stator PWM"><meta property="og:site_name" content="Andrew Mosqueda - Andrew Mosqueda"><meta property="og:description" content="Introduction This tutorial is done with NUCLEO-F302R8 MCU board with X-NUCLEO-IHM07M1 expansion board and BR2804-1700KV-1 3-phase motor. The IDE used is STM32CubeIDE 1.8.0. The X-NUCLEO-IHM07M1 expansion board uses L6230 DMOS driver IC. The EN1, IN1, EN2, IN2, EN3 and IN3 pins of the IC are&hellip;"><meta property="og:url" content="https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-1/"><meta property="og:type" content="article"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--post-entry-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://andrewmosqueda.github.io/assets/css/style.css?v=eacb492672ba3c1641d647982de266ba"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-1/"},"headline":"Sensorless 6-Step Control for 3-Phase Brushless Motor Tutorial - Part 1 Stator PWM","datePublished":"2022-02-01T09:18","dateModified":"2022-02-01T15:21","description":"Introduction This tutorial is done with NUCLEO-F302R8 MCU board with X-NUCLEO-IHM07M1 expansion board and BR2804-1700KV-1 3-phase motor. The IDE used is STM32CubeIDE 1.8.0. The X-NUCLEO-IHM07M1 expansion board uses L6230 DMOS driver IC. The EN1, IN1, EN2, IN2, EN3 and IN3 pins of the IC are&hellip;","author":{"@type":"Person","name":"Andrew Mosqueda"},"publisher":{"@type":"Organization","name":"Andrew Mosqueda"}}</script></head><body><header class="topbar" id="js-header"><div class="topbar__inner"><a class="logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2022-02-01T15:22">February 1, 2022</time></div><div class="infobar__search"><form action="https://andrewmosqueda.github.io/search.html"><input type="search" name="q" placeholder="search..." aria-label="Search input"> <button type="submit" aria-label="Submit"><svg role="presentation" focusable="false" width="15px" height="14px"><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#search"/></svg></button></form></div></div><main class="main"><article class="post"><header class="u-header post__header"><h1>Sensorless 6-Step Control for 3-Phase Brushless Motor Tutorial - Part 1 Stator PWM</h1><div class="u-header__meta u-small"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="eager" class="u-header__avatar" alt="Andrew Mosqueda"><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a> <time datetime="2022-02-01T09:18">February 1, 2022</time></div></div></header><div class="post__entry u-inner"><h2>Introduction</h2><p>This tutorial is done with NUCLEO-F302R8 MCU board with X-NUCLEO-IHM07M1 expansion board and BR2804-1700KV-1 3-phase motor. The IDE used is STM32CubeIDE 1.8.0.</p><h2>Create Project</h2><ol><li>Open STM32CubeIDE.</li><li>File-&gt;New-&gt;STM32 Project.</li><li>After "STM32 Project" dialog is loaded. Click on "Board Selector" Tab. Type "NUCLEO-F302R8" as the part number. Click the board listed on the left then click Next button.<br><figure class="post__image align-center"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12//New-Project.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12//responsive/New-Project-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12//responsive/New-Project-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12//responsive/New-Project-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12//responsive/New-Project-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12//responsive/New-Project-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12//responsive/New-Project-2xl.jpg 1600w" alt="New Project" width="417" height="325"></figure></li><li>Name the project "Six_Step" then click Finish button.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12//Project-Name.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12//responsive/Project-Name-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12//responsive/Project-Name-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12//responsive/Project-Name-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12//responsive/Project-Name-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12//responsive/Project-Name-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12//responsive/Project-Name-2xl.jpg 1600w" alt="Project Name" width="337" height="366"></figure></li><li>If "Board Project Options" dialog box is displayed. Click "Yes" to initialize all peripherals with their default Mode.</li></ol><figure class="post__image align-center">At this point, the Pinout &amp; Configuration window of the project should be displayed like below.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12//Pinout-and-Config-Window.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12//responsive/Pinout-and-Config-Window-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12//responsive/Pinout-and-Config-Window-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12//responsive/Pinout-and-Config-Window-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12//responsive/Pinout-and-Config-Window-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12//responsive/Pinout-and-Config-Window-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12//responsive/Pinout-and-Config-Window-2xl.jpg 1600w" alt="Pinout and Configuration window" width="882" height="515"></figure><h2>Configure the Stator PWM</h2><p>The X-NUCLEO-IHM07M1 expansion board uses L6230 DMOS driver IC. The EN1, IN1, EN2, IN2, EN3 and IN3 pins of the IC are used to control the MOSFETS of the IC. Below table is the definition and map of these pins to the board header pins and MCU pins.</p><table style="border-collapse: collapse; width: 99.4299%; height: 450px;" border="1"><tbody><tr style="height: 48px;"><td style="width: 16.6667%; height: 48px;">L6230 Pin</td><td style="width: 20.7978%; height: 48px;">Definition</td><td style="width: 29.2022%; height: 48px;">Board Header Pin</td><td style="width: 33.3333%; height: 48px;">MCU Pin</td></tr><tr style="height: 48px;"><td style="width: 16.6667%; height: 48px;">EN1</td><td style="width: 20.7978%; height: 48px;">PH1 Enable</td><td style="width: 29.2022%; height: 48px;">C7_1</td><td style="width: 33.3333%; height: 48px;">PC10</td></tr><tr style="height: 48px;"><td style="width: 16.6667%; height: 48px;">IN1</td><td style="width: 20.7978%; height: 48px;">PH1 Hi/Low</td><td style="width: 29.2022%; height: 48px;">C10_23</td><td style="width: 33.3333%; height: 48px;">PA8</td></tr><tr style="height: 48px;"><td style="width: 16.6667%; height: 48px;">EN2</td><td style="width: 20.7978%; height: 48px;">PH2 Enable</td><td style="width: 29.2022%; height: 48px;">C7_2</td><td style="width: 33.3333%; height: 48px;">PC11</td></tr><tr style="height: 48px;"><td style="width: 16.6667%; height: 48px;">IN2</td><td style="width: 20.7978%; height: 48px;">PH2 Hi/Low</td><td style="width: 29.2022%; height: 48px;">C10_21</td><td style="width: 33.3333%; height: 48px;">PA9</td></tr><tr style="height: 48px;"><td style="width: 16.6667%; height: 48px;">EN3</td><td style="width: 20.7978%; height: 48px;">PH3 Enable</td><td style="width: 29.2022%; height: 48px;">C7_3</td><td style="width: 33.3333%; height: 48px;">PC12</td></tr><tr style="height: 48px;"><td style="width: 16.6667%; height: 48px;">IN3</td><td style="width: 20.7978%; height: 48px;">PH3 Hi/Low</td><td style="width: 29.2022%; height: 48px;">C10_33</td><td style="width: 33.3333%; height: 48px;">PA10</td></tr></tbody></table><p>We will connect the MCU Pins PA8, PA9 and PA10 defined above as PWM output of the TIMER1.</p><ol><li>On the pinout window, click PA8 and select TIM1_CH1.<br><figure class="post__image align-center"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/PA8-TIM1_CH1-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/PA8-TIM1_CH1-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/PA8-TIM1_CH1-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/PA8-TIM1_CH1-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/PA8-TIM1_CH1-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/PA8-TIM1_CH1-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/PA8-TIM1_CH1-2-2xl.jpg 1600w" alt="" width="150" height="263"></figure></li><li>Do the same thing to PA9 (TIM1_CH2) and PA10 (TIM1_CH3). The pinout setting should look like below.<br><figure class="post__image align-center"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/TIM1-pinout.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout-2xl.jpg 1600w" alt="" width="345" height="285"></figure></li><li>Click Timers-&gt;TIM1 and configure the channels as shown below. Channel 4 will be used later in an interrupt.<br><figure class="post__image align-center"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/TIM1-pwm-channel-config.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pwm-channel-config-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pwm-channel-config-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pwm-channel-config-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pwm-channel-config-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pwm-channel-config-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pwm-channel-config-2xl.jpg 1600w" alt="" width="358" height="239"></figure><br>After the configuration, the PA8, PA9 and PA10 pins should turn green as shown below.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/TIM1-pinout2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM1-pinout2-2xl.jpg 1600w" alt="" width="396" height="333"></figure></li></ol><p>The MCU pins PC10, PC11 and PC12 that will be used to enable each phase of the L6230 DMOS driver IC need not be controlled by PWM. For each pin, set it as GPIO_Output.</p><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/PC10-PC11-PC12.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/PC10-PC11-PC12-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/PC10-PC11-PC12-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/PC10-PC11-PC12-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/PC10-PC11-PC12-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/PC10-PC11-PC12-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/PC10-PC11-PC12-2xl.jpg 1600w" alt="" width="176" height="282"></figure><h2>Cycle by Cycle Duty Control</h2><p>We will control the duty cycle of the Stator PWM by utilizing the current on the stator. The L6230 DMOS driver IC has a built-in analog comparator that we can utilize to clear the output of the Stator PWM for every Stator PWM cycle. Below table is the definition of the comparator pins and map of these pins to the board header pins and MCU pins.</p><table style="border-collapse: collapse; width: 100%;" border="1"><tbody><tr><td style="width: 20%;">L6230 Pin</td><td style="width: 20%;">Definition</td><td style="width: 20%;">Board Header Pin</td><td style="width: 20%;">MCU Pin</td></tr><tr><td style="width: 20%;">CP+</td><td style="width: 20%;">Stator Current Feedback</td><td style="width: 20%;">C7_36</td><td style="width: 20%;">PC1</td></tr><tr><td style="width: 20%;">CP- (Filtered)</td><td style="width: 20%;">Current Reference</td><td style="width: 20%;"><p>J16 Ring (Filtered)</p><p>C10_27 (PWM)</p></td><td style="width: 20%;">PB4 (Ref PWM Output)</td></tr><tr><td style="width: 20%;">CPOUT</td><td style="width: 20%;">Comparator Output</td><td style="width: 20%;">C10_12</td><td style="width: 20%;">PA12</td></tr></tbody></table><p>We'll use PA12 pin as input to the TIMER1 as clear pin so everytime the L6230 DMOS driver IC CPOUT turns high, the output of the PWM is cleared or reset.</p><ol><li>On the pinout view, click on PA12 pin and select TIM1_ETR. Then on the Mode window, Select ETR IO as Clearing Source. <figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/Timer-ETR.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/Timer-ETR-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/Timer-ETR-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/Timer-ETR-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/Timer-ETR-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/Timer-ETR-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/Timer-ETR-2xl.jpg 1600w" alt="" width="679" height="428"></figure></li><li>On the Configuration, Enable Clear Channel 1, Clear Channel 2 and Clear Channel 3.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/Enable-Channel-ETR.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/Enable-Channel-ETR-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/Enable-Channel-ETR-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/Enable-Channel-ETR-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/Enable-Channel-ETR-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/Enable-Channel-ETR-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/Enable-Channel-ETR-2xl.jpg 1600w" alt="" width="427" height="327"></figure></li></ol><p> </p><p>Next, we'll set the MCU pin PB4 as reference PWM to the comparator of the L6230 DMOS driver IC.</p><ol><li>On the pinout view, click PB4 and select TIM16_CH1.</li><li>Click TIM16. Click Activated and select "PWM Generation CH1" as Channel1.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/TIM16.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/TIM16-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM16-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM16-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM16-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM16-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/TIM16-2xl.jpg 1600w" alt="" width="405" height="256"></figure></li></ol><h2>CODING</h2><p>Save the configuration to generate all the initialization code.</p><ol><li>Ctrl+s to save. Wait until main.c file is generated and displayed.</li><li>Insert the following definition codes after the /* USER CODE BEGIN PD */ line: <br><code>#define PWM_STATOR 50E+3 // Hz</code><br><code>#define CURRENT_IREF_LIMIT 1 // Ampere</code><br><code>#define PWM_REF 10E+3 // Hz</code><br><code>#define R44 0.33 // Ω - sense resistor</code><br><br><code>#define TIM1_PERIOD (64E+6/PWM_STATOR - 1) // calc good only if prescaler is 0</code><br><code>#define TIM1_DEFAULT_DUTY (TIM1_PERIOD/2) // limit stator duty to 0.5</code><br><code>#define TIM16_PERIOD (64E+6/PWM_REF - 1) // calc good only if prescaler is 0</code><br><code>#define CURRENT_VREF_LIMIT (CURRENT_IREF_LIMIT*R44) // volts</code><br><code>#define TIM16_DUTY (TIM16_PERIOD*CURRENT_VREF_LIMIT/3.3) // current reference duty cycle</code><br><br><code>#define PH1_HIGH TIM1-&gt;CCR1 = TIM1_DEFAULT_DUTY; HAL_GPIO_WritePin(GPIOC, GPIO_PIN_10, GPIO_PIN_SET);</code><br><code>#define PH1_LOW TIM1-&gt;CCR1 = 0; HAL_GPIO_WritePin(GPIOC, GPIO_PIN_10, GPIO_PIN_SET);</code><br><code>#define PH1_OFF HAL_GPIO_WritePin(GPIOC, GPIO_PIN_10, GPIO_PIN_RESET);</code><br><br><code>#define PH2_HIGH TIM1-&gt;CCR2 = TIM1_DEFAULT_DUTY; HAL_GPIO_WritePin(GPIOC, GPIO_PIN_11, GPIO_PIN_SET);</code><br><code>#define PH2_LOW TIM1-&gt;CCR2 = 0; HAL_GPIO_WritePin(GPIOC, GPIO_PIN_11, GPIO_PIN_SET);</code><br><code>#define PH2_OFF HAL_GPIO_WritePin(GPIOC, GPIO_PIN_11, GPIO_PIN_RESET);</code><br><br><code>#define PH3_HIGH TIM1-&gt;CCR2 = TIM1_DEFAULT_DUTY; HAL_GPIO_WritePin(GPIOC, GPIO_PIN_12, GPIO_PIN_SET);</code><br><code>#define PH3_LOW TIM1-&gt;CCR2 = 0; HAL_GPIO_WritePin(GPIOC, GPIO_PIN_12, GPIO_PIN_SET);</code><br><code>#define PH3_OFF HAL_GPIO_WritePin(GPIOC, GPIO_PIN_12, GPIO_PIN_RESET);</code></li><li>Insert the following code after the /* USER CODE BEGIN 2 */ line:<br><code>//TIMER 1 - Stator PWM</code><br><code>  HAL_TIM_Base_Start(&amp;htim1);</code><br><code>  HAL_TIM_PWM_Start(&amp;htim1, TIM_CHANNEL_1);</code><br><code>  HAL_TIM_PWM_Start(&amp;htim1, TIM_CHANNEL_2);</code><br><code>  HAL_TIM_PWM_Start(&amp;htim1, TIM_CHANNEL_3);</code><br><code>  HAL_TIM_PWM_Start(&amp;htim1, TIM_CHANNEL_4);</code><br><code>  TIM1-&gt;ARR = TIM1_PERIOD; </code><br><code>  PH1_HIGH PH2_LOW PH3_OFF</code><br><code>  </code><br><code>  //TIMER 16 - Current Reference PWM</code><br><code>  HAL_TIM_Base_Start(&amp;htim16);</code><br><code>  HAL_TIM_PWM_Start(&amp;htim16, TIM_CHANNEL_1);</code><br><code>  TIM16-&gt;ARR = TIM16_PERIOD; </code><br><code>  TIM16-&gt;CCR1 = TIM16_DUTY; </code></li></ol><h2>TEST</h2><ol><li>On the X-NUCLEO board. Set JP1 and JP2 to open position. Set JP5 and JP6 to 1Sh position.</li><li>Connect the 12V DC power supply to J1 and the motor to J2.</li><li>Connect an oscilloscope probe to C10_23 of the X-NUCLEO board. This probe is used to monitor the PWM signal applied to the driver IC.</li><li>Connect an oscilloscope probe to C7_36 of the X-NUCLEO board. This probe is used to monitor the current feedback voltage that is fed to the built-in comparator of the L6230 DMOS driver IC.</li><li>Click Run-&gt;Run menu to compile and load the program to the MCU. We should get a similar waveform on the oscilloscope below. The orange waveform is the PWM applied to the driver IC while the blue waveform is the current feedback.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/Oscilloscope-PWM-PH1-vs-Current-Reference.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-PWM-PH1-vs-Current-Reference-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-PWM-PH1-vs-Current-Reference-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-PWM-PH1-vs-Current-Reference-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-PWM-PH1-vs-Current-Reference-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-PWM-PH1-vs-Current-Reference-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-PWM-PH1-vs-Current-Reference-2xl.jpg 1600w" alt="" width="749" height="457"></figure></li><li>Transfer the probe from C10_23 to J16. J16 is the negative input reference of the built-in comparator of the driver IC. Add another probe to C10_12. C10_12 is the comparator output. We should get a similar waveform below. The orange waveform is now the current reference that limits the current to rise above it. The blue waveform is the comparator output. There is some delay on the turn off of the PWM but at least we have some degree on the control of the current limit.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/Oscilloscope-Current-vs-reference-vs-comparator-output.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output-2xl.jpg 1600w" alt="" width="757" height="456"></figure></li><li>Next, we set the current limit from 1A from 0A in the code to confirm that we can control the current limit. In line 36, change the code to #define CURRENT_IREF_LIMIT <strong>0</strong>. Caution: Setting this value too high may turn the IC too hot.</li><li>Click Run-&gt;Run again in the menu to compile and load the program to the MCU. After loading the program, notice that the current reference is now 0V and the peak voltage of the current feedback is reduced to 893.879mV. We can now confirm that we have a cycle-by-cycle control of the Stator PWM.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/12/Oscilloscope-Current-vs-reference-vs-comparator-output2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/12/responsive/Oscilloscope-Current-vs-reference-vs-comparator-output2-2xl.jpg 1600w" alt="" width="758" height="457"></figure></li></ol></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on February 1, 2022</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio box"><img class="u-author__avatar" src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="lazy" alt="Andrew Mosqueda"><div><h4 class="h6"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://andrewmosqueda.github.io/hysteretic-current-mode-buck-converter-for-dspic33/" class="post__nav__link" rel="prev"><div class="u-small">Previous Post<h5>Hysteretic Current Mode Buck Converter with dsPIC33</h5></div></a></div></nav><div class="post__related box"><h3 class="box__title">Related posts</h3><div class="post__related-wrap"><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/" class="inverse">LTspice simulation of hysteretic current control for buck converter</a></h4><time datetime="2021-11-20T22:27" class="u-small">November 20, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/using-the-slope-compensation-for-the-current-mode-control/" class="inverse">Using the slope compensation for the current mode control</a></h4><time datetime="2021-11-14T16:12" class="u-small">November 14, 2021</time></figcaption></figure></div></div></footer></article><div class="comments box"><h3 class="box__title">Comments</h3><div id="disqus_thread"></div><script>var disqus_config = function () {
                    this.page.url = 'https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-1/';
            		this.page.identifier = '12';
                };
            
                var disqus_loaded = false;
            
                function publiiLoadDisqus() {
                    if(disqus_loaded) {
                        return false;
                    }
            
                    var top = document.getElementById('disqus_thread').offsetTop;
            
                    if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                        disqus_loaded = true;
            
                        (function () {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    }
                }
            
                publiiLoadDisqus();
            
                window.onscroll = function() {
                    publiiLoadDisqus();
                };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></main><div class="sidebar"><section class="box featured"><h3 class="box__title">Featured</h3><ul class="featured__container"><li class="featured__item"><div><a href="https://andrewmosqueda.github.io/current-mode/" class="featured__title">5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</a> <time class="u-small" datetime="2021-09-11T21:52">September 11, 2021</time></div></li></ul></section><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__image-link"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" alt="Andrew Mosqueda"></a><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__title">Andrew Mosqueda</a> <span class="u-small">Post: 12</span></div></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a><nav><ul class="footer__nav"></ul></nav><div class="footer__follow"><a href="https://www.facebook.com/andrew.mosqueda" aria-label="Facebook"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://www.linkedin.com/in/alex-andrew-mosqueda-31197876/" aria-label="LinkedIn"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#linkedin"/></svg> </a><a href="https://www.youtube.com/channel/UCHcJ7jRLmntRZrI8h41y3Yg" aria-label="Youtube"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#youtube"/></svg></a></div><div class="footer__copyright"><p>andrewgs7311@gmail.com</p></div></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://andrewmosqueda.github.io/assets/js/scripts.min.js?v=3dc768003cc6d66c9e7bf0904e71d3e8"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>