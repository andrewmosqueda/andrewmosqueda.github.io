<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Sensorless 6-step Control for 3-Phase Brushless Motor Tutorial - Part 2 Potentiometer - Andrew Mosqueda</title><meta name="description" content="INTRODUCTION In this tutorial, we will configure and add code to utilize the potentiometer of the X-NUCLEO-IHM07M1 board in adjusting the current limit of the stator PWM. Below table summarizes the map of the potentiometer signal vs board connector pin and MCU pin. We will&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-2-potentiometer/"><link rel="alternate" type="application/atom+xml" href="https://andrewmosqueda.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://andrewmosqueda.github.io/feed.json"><meta property="og:title" content="Sensorless 6-step Control for 3-Phase Brushless Motor Tutorial - Part 2 Potentiometer"><meta property="og:site_name" content="Andrew Mosqueda - Andrew Mosqueda"><meta property="og:description" content="INTRODUCTION In this tutorial, we will configure and add code to utilize the potentiometer of the X-NUCLEO-IHM07M1 board in adjusting the current limit of the stator PWM. Below table summarizes the map of the potentiometer signal vs board connector pin and MCU pin. We will&hellip;"><meta property="og:url" content="https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-2-potentiometer/"><meta property="og:type" content="article"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--post-entry-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://andrewmosqueda.github.io/assets/css/style.css?v=eacb492672ba3c1641d647982de266ba"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-2-potentiometer/"},"headline":"Sensorless 6-step Control for 3-Phase Brushless Motor Tutorial - Part 2 Potentiometer","datePublished":"2022-02-01T15:56","dateModified":"2022-02-02T11:06","description":"INTRODUCTION In this tutorial, we will configure and add code to utilize the potentiometer of the X-NUCLEO-IHM07M1 board in adjusting the current limit of the stator PWM. Below table summarizes the map of the potentiometer signal vs board connector pin and MCU pin. We will&hellip;","author":{"@type":"Person","name":"Andrew Mosqueda"},"publisher":{"@type":"Organization","name":"Andrew Mosqueda"}}</script></head><body><header class="topbar" id="js-header"><div class="topbar__inner"><a class="logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2022-02-02T11:07">February 2, 2022</time></div><div class="infobar__search"><form action="https://andrewmosqueda.github.io/search.html"><input type="search" name="q" placeholder="search..." aria-label="Search input"> <button type="submit" aria-label="Submit"><svg role="presentation" focusable="false" width="15px" height="14px"><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#search"/></svg></button></form></div></div><main class="main"><article class="post"><header class="u-header post__header"><h1>Sensorless 6-step Control for 3-Phase Brushless Motor Tutorial - Part 2 Potentiometer</h1><div class="u-header__meta u-small"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="eager" class="u-header__avatar" alt="Andrew Mosqueda"><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a> <time datetime="2022-02-01T15:56">February 1, 2022</time></div></div></header><div class="post__entry u-inner"><h2>INTRODUCTION</h2><p>In this tutorial, we will configure and add code to utilize the potentiometer of the X-NUCLEO-IHM07M1 board in adjusting the current limit of the stator PWM. Below table summarizes the map of the potentiometer signal vs board connector pin and MCU pin. We will set PB1 of the MCU as an analog input. We will configure an ADC and DMA to automatically store the voltage level on PB1 to a memory. </p><table style="border-collapse: collapse; width: 100%;" border="1"><tbody><tr><td style="width: 33.3333%;">Signal Name</td><td style="width: 33.3333%;">Board Connector</td><td style="width: 33.3333%;">MCU Pin</td></tr><tr><td style="width: 33.3333%;">SPEED</td><td style="width: 33.3333%;">C10_24</td><td style="width: 33.3333%;">PB1</td></tr></tbody></table><p>The TIMER16 that is used for current reference PWM will be configured to have its interrupt enabled. The interrupt will be used to change the value of the current reference based from the value stored in the memory that is being updated by the DMA.</p><h2>CONFIGURATION</h2><ol><li>Open the Six_Step project on STM32CubeIDE. This is the project generated on the first tutorial <a href="https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-1/" target="_blank" rel="noopener noreferrer">Stator PWM</a>.</li><li>Open the Six_Step.ioc.</li><li>On the Pinout view, click on PB1 and select ADC1_IN12.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/13/PB1.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/13/responsive/PB1-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/13/responsive/PB1-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/13/responsive/PB1-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/13/responsive/PB1-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/13/responsive/PB1-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/13/responsive/PB1-2xl.jpg 1600w" alt="" width="348" height="273"></figure></li><li>Click Analog-&gt;ADC1 and select IN12 Single-ended for IN12.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/13/ADC-Mode-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Mode-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Mode-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Mode-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Mode-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Mode-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Mode-2-2xl.jpg 1600w" alt="" width="450" height="303"></figure></li><li>Click System Core-&gt;DMA. Configure as illustrated below.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/13/DMA.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/13/responsive/DMA-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/13/responsive/DMA-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/13/responsive/DMA-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/13/responsive/DMA-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/13/responsive/DMA-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/13/responsive/DMA-2xl.jpg 1600w" alt="" width="488" height="227"></figure></li><li>Go back to the ADC1. Configure as illustrated below.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/13/ADC-Configuration.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Configuration-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Configuration-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Configuration-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Configuration-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Configuration-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/13/responsive/ADC-Configuration-2xl.jpg 1600w" alt="" width="356" height="408"></figure></li><li>Click System Core-&gt;NVIC. Enable TIM1 update and TIM16 interrupts.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/13/TIM16-interrupt.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/13/responsive/TIM16-interrupt-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/13/responsive/TIM16-interrupt-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/13/responsive/TIM16-interrupt-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/13/responsive/TIM16-interrupt-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/13/responsive/TIM16-interrupt-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/13/responsive/TIM16-interrupt-2xl.jpg 1600w" alt="" width="387" height="329"></figure></li><li>Ctrl+s to save the configuration and go back to main.c</li></ol><h2>CODING</h2><ol><li>In main.c <code>/* Initialize all configured peripherals */</code>, check if <code>MX_DMA_Init();</code> is written first before <code>MX_ADC1_Init();</code>. The DMA must be initialized first before the ADC, else the DMA will not work.</li><li>Add <code>#define ADC_BUF_LEN 1</code> after<code>#define R44 0.33</code> line.</li><li>Add <code>uint16_t adc_buf[ADC_BUF_LEN];</code> after <code>/* USER CODE BEGIN PV */</code> line.</li><li>After <code>TIM16-&gt;CCR1 = TIM16_DUTY;</code> line, add the following:<br><code>//ADC for current reference limit</code><br><code>   HAL_ADC_Start_DMA(&amp;hadc1, (uint32_t*) adc_buf, ADC_BUF_LEN);</code></li><li>Rename <code>HAL_TIM_Base_Start(&amp;htim16);</code>  to <code>HAL_TIM_Base_Start_<span style="text-decoration: underline;"><strong>IT</strong></span>(&amp;htim16);</code></li><li>Rename <code>HAL_TIM_PWM_Start(&amp;htim16, TIM_CHANNEL_1);</code> to <code>HAL_TIM_PWM_Start_<span style="text-decoration: underline;"><strong>IT</strong></span>(&amp;htim16, TIM_CHANNEL_1);</code></li><li>After <code>/* USER CODE BEGIN 4 */</code> add the following code:<br><code>void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)</code><br><code>{</code><br><code> if(htim==&amp;htim16) TIM16-&gt;CCR1 = (adc_buf[0] * TIM16_PERIOD) &gt;&gt; 12 ;</code><br><code>}</code></li></ol><h2>TEST</h2><ol><li>On the X-NUCLEO board. Set JP1 and JP2 to open position. Set JP5 and JP6 to 1Sh position.</li><li>Connect the 12V DC power supply to J1 and the motor to J2.</li><li>Connect an oscilloscope probe to J16. J16 is the negative input reference of the built-in comparator of the driver IC.</li><li>Connect an oscilloscope probe to C7_36. C7_36 is the stator current feedback signal.</li><li>Connect an oscilloscope probe to C10_12. C10_12 is the output of the driver IC comparator.</li><li>Make sure the potentiometer is set to minimum position as shown below:<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/13/Pot_minjpg.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_minjpg-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_minjpg-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_minjpg-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_minjpg-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_minjpg-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_minjpg-2xl.jpg 1600w" alt="" width="689" height="499"></figure>Caution: If potentiometer is set high, the driver IC may get too hot.</li><li>Click Run-&gt;Run menu to compile and load the program to the MCU. We should get a similar waveform on the oscilloscope below. The orange waveform is the current reference. The purple waveform is the current feedback. The blue waveform in the bottom is the output of the comparator.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/13/Pot_0.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_0-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_0-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_0-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_0-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_0-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_0-2xl.jpg 1600w" alt="" width="709" height="432"></figure></li><li>Rotate the potentiometer by about 45°. Observe that the peak of reference current and peak current increases as shown below. We can confirm now that the current limit of the stator can be adjusted by the potentiometer.<figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/13/Pot_45.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_45-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_45-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_45-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_45-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_45-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/13/responsive/Pot_45-2xl.jpg 1600w" alt="" width="716" height="425"></figure></li></ol><p> </p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on February 2, 2022</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio box"><img class="u-author__avatar" src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="lazy" alt="Andrew Mosqueda"><div><h4 class="h6"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-1/" class="post__nav__link" rel="prev"><div class="u-small">Previous Post<h5>Sensorless 6-Step Control for 3-Phase Brushless Motor Tutorial - Part 1 Stator PWM</h5></div></a></div></nav><div class="post__related box"><h3 class="box__title">Related posts</h3><div class="post__related-wrap"><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-1/" class="inverse">Sensorless 6-Step Control for 3-Phase Brushless Motor Tutorial - Part 1 Stator PWM</a></h4><time datetime="2022-02-01T09:18" class="u-small">February 1, 2022</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/" class="inverse">LTspice simulation of hysteretic current control for buck converter</a></h4><time datetime="2021-11-20T22:27" class="u-small">November 20, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/using-the-slope-compensation-for-the-current-mode-control/" class="inverse">Using the slope compensation for the current mode control</a></h4><time datetime="2021-11-14T16:12" class="u-small">November 14, 2021</time></figcaption></figure></div></div></footer></article><div class="comments box"><h3 class="box__title">Comments</h3><div id="disqus_thread"></div><script>var disqus_config = function () {
                    this.page.url = 'https://andrewmosqueda.github.io/sensorless-6-step-control-for-3-phase-brushless-motor-tutorial-part-2-potentiometer/';
            		this.page.identifier = '13';
                };
            
                var disqus_loaded = false;
            
                function publiiLoadDisqus() {
                    if(disqus_loaded) {
                        return false;
                    }
            
                    var top = document.getElementById('disqus_thread').offsetTop;
            
                    if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                        disqus_loaded = true;
            
                        (function () {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    }
                }
            
                publiiLoadDisqus();
            
                window.onscroll = function() {
                    publiiLoadDisqus();
                };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></main><div class="sidebar"><section class="box featured"><h3 class="box__title">Featured</h3><ul class="featured__container"><li class="featured__item"><div><a href="https://andrewmosqueda.github.io/current-mode/" class="featured__title">5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</a> <time class="u-small" datetime="2021-09-11T21:52">September 11, 2021</time></div></li></ul></section><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__image-link"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" alt="Andrew Mosqueda"></a><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__title">Andrew Mosqueda</a> <span class="u-small">Post: 13</span></div></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a><nav><ul class="footer__nav"></ul></nav><div class="footer__follow"><a href="https://www.facebook.com/andrew.mosqueda" aria-label="Facebook"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://www.linkedin.com/in/alex-andrew-mosqueda-31197876/" aria-label="LinkedIn"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#linkedin"/></svg> </a><a href="https://www.youtube.com/channel/UCHcJ7jRLmntRZrI8h41y3Yg" aria-label="Youtube"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#youtube"/></svg></a></div><div class="footer__copyright"><p>andrewgs7311@gmail.com</p></div></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://andrewmosqueda.github.io/assets/js/scripts.min.js?v=3dc768003cc6d66c9e7bf0904e71d3e8"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>