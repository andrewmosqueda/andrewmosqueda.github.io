<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Simulation of the PCI-Current Limit Logic of dsPIC33CH - Andrew Mosqueda</title><meta name="description" content="INTRODUCTION The dsPIC33CH IC has a PCI CL (PWM Control Input-Current Limit) Logic that is use for Current Mode Controlled Converter. An equivalent circuit in LTSPICE is simulated to gain better insights of this logic system. The simulated circuit is based on actual circuit values&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/"><link rel="alternate" type="application/atom+xml" href="https://andrewmosqueda.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://andrewmosqueda.github.io/feed.json"><meta property="og:title" content="Simulation of the PCI-Current Limit Logic of dsPIC33CH"><meta property="og:site_name" content="Andrew Mosqueda - Andrew Mosqueda"><meta property="og:description" content="INTRODUCTION The dsPIC33CH IC has a PCI CL (PWM Control Input-Current Limit) Logic that is use for Current Mode Controlled Converter. An equivalent circuit in LTSPICE is simulated to gain better insights of this logic system. The simulated circuit is based on actual circuit values&hellip;"><meta property="og:url" content="https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/"><meta property="og:type" content="article"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--post-entry-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://andrewmosqueda.github.io/assets/css/style.css?v=eacb492672ba3c1641d647982de266ba"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/"},"headline":"Simulation of the PCI-Current Limit Logic of dsPIC33CH","datePublished":"2021-09-26T17:12","dateModified":"2021-09-29T21:48","description":"INTRODUCTION The dsPIC33CH IC has a PCI CL (PWM Control Input-Current Limit) Logic that is use for Current Mode Controlled Converter. An equivalent circuit in LTSPICE is simulated to gain better insights of this logic system. The simulated circuit is based on actual circuit values&hellip;","author":{"@type":"Person","name":"Andrew Mosqueda"},"publisher":{"@type":"Organization","name":"Andrew Mosqueda"}}</script></head><body><header class="topbar" id="js-header"><div class="topbar__inner"><a class="logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2021-11-28T16:36">November 28, 2021</time></div><div class="infobar__search"><form action="https://andrewmosqueda.github.io/search.html"><input type="search" name="q" placeholder="search..." aria-label="Search input"> <button type="submit" aria-label="Submit"><svg role="presentation" focusable="false" width="15px" height="14px"><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#search"/></svg></button></form></div></div><main class="main"><article class="post"><header class="u-header post__header"><h1>Simulation of the PCI-Current Limit Logic of dsPIC33CH</h1><div class="u-header__meta u-small"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="eager" class="u-header__avatar" alt="Andrew Mosqueda"><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a> <time datetime="2021-09-26T17:12">September 26, 2021</time></div></div></header><div class="post__entry u-inner"><h2>INTRODUCTION</h2><p>The dsPIC33CH IC has a PCI CL (PWM Control Input-Current Limit) Logic that is use for Current Mode Controlled Converter. An equivalent circuit in LTSPICE is simulated to gain better insights of this logic system. The simulated circuit is based on actual circuit values in the DM330038 dsPIC33CH Curiosity Development Board.</p><p>SIMPLIFIED BUCK CONVERTER SCHEMATIC</p><figure class="post__image">Below is a simplified schematic of the current mode controlled buck converter of the board with connection to the dsPIC33CH IC. The PWM duty cycle is fixed at usually 95%. the PCI CL purpose is to override (block or truncate) the PWM output everytime the output of the current sense circuit exceeds the reference value. The reference value is an analog voltage generated from the PID by a DAC.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/8/close-loop.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/8/responsive/close-loop-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/8/responsive/close-loop-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/8/responsive/close-loop-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/8/responsive/close-loop-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/8/responsive/close-loop-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/8/responsive/close-loop-2xl.jpg 1600w" alt="Buck Converter with dsPIC33CH" width="983" height="578"></figure><p>From above figure, we can see that the PCI-CL is part of the PWM Module of the IC.</p><p>PCI DIAGRAM</p><figure class="post__image">Below is the diagram of the PCI from DS70005320B document.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/8/pci.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/8/responsive/pci-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/8/responsive/pci-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/8/responsive/pci-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/8/responsive/pci-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/8/responsive/pci-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/8/responsive/pci-2xl.jpg 1600w" alt="PWM Control Input Logic" width="933" height="656"></figure><p>The table below are the register values from above diagram that are needed to configure in order for the PCI to become a current limit logic for the current mode converter:</p><table style="border-collapse: collapse; width: 73.5462%;" border="1"><tbody><tr><td style="width: 19.3732%;"><strong>Register</strong></td><td style="width: 10.9378%;"><strong>Hex Value</strong></td><td style="width: 56.2236%;"><strong>Value Definition</strong></td></tr><tr><td style="width: 19.3732%;">PSS</td><td style="width: 10.9378%;">28</td><td style="width: 56.2236%;">Slave 1 Comparator 1 output</td></tr><tr><td style="width: 19.3732%;">PPS</td><td style="width: 10.9378%;">0</td><td style="width: 56.2236%;">Not inverted</td></tr><tr><td style="width: 19.3732%;">PSYNC</td><td style="width: 10.9378%;">0</td><td style="width: 56.2236%;">disabled</td></tr><tr><td style="width: 19.3732%;">AQSS</td><td style="width: 10.9378%;">2</td><td style="width: 56.2236%;">LEB is Active</td></tr><tr><td style="width: 19.3732%;">AQPS</td><td style="width: 10.9378%;">1</td><td style="width: 56.2236%;">Inverted</td></tr><tr><td style="width: 19.3732%;">TERM</td><td style="width: 10.9378%;">1</td><td style="width: 56.2236%;">Auto-Terminate</td></tr><tr><td style="width: 19.3732%;">SWTERM</td><td style="width: 10.9378%;">0</td><td style="width: 56.2236%;">disabled</td></tr><tr><td style="width: 19.3732%;">TSYNCDIS</td><td style="width: 10.9378%;">0</td><td style="width: 56.2236%;">PWM EOC</td></tr><tr><td style="width: 19.3732%;">TQSS</td><td style="width: 10.9378%;">0</td><td style="width: 56.2236%;">No Termination Qualifier, Force 1</td></tr><tr><td style="width: 19.3732%;">TQPS</td><td style="width: 10.9378%;">0</td><td style="width: 56.2236%;">Not inverted</td></tr><tr><td style="width: 19.3732%;">ACP</td><td style="width: 10.9378%;">3</td><td style="width: 56.2236%;">Latched</td></tr><tr><td style="width: 19.3732%;">BPEN</td><td style="width: 10.9378%;">0</td><td style="width: 56.2236%;">disabled</td></tr><tr><td style="width: 19.3732%;">SWPCI</td><td style="width: 10.9378%;">0</td><td style="width: 56.2236%;">Drives '0'</td></tr><tr><td style="width: 19.3732%;">SWPCIM</td><td style="width: 10.9378%;">0</td><td style="width: 56.2236%;">PCI acceptance logic</td></tr></tbody></table><p>By using the values of the registers in the above table. The PCI logic is simplified to the diagram below.</p><figure class="post__image"><br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/8/PCI-CL-Simplified.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simplified-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simplified-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simplified-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simplified-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simplified-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simplified-2xl.jpg 1600w" alt="PCI Current Limit Logic Simplified Diagram" width="907" height="256"><figcaption>PCI Current Limit Simplified Diagram</figcaption></figure><p>The Leading Edge Blanking (LEB) is a counter circuit that is synchronized with the PWM output and becomes Active after the PWM output becomes high and then resets/stop after the PWM becomes low. The purpose of the LEB is to ignore switching transients. </p><p>The Auto-Terminate is a logic circuit that detects falling signal of the comparator output and is reset every start of PWM cycle.</p><p>LTSPICE SIMULATION CIRCUIT</p><figure class="post__image">Below is the LTSPICE schematic for the simulation of this simplfied current limit logic with the comparator, pwm and power circuit. The Analog Comparator Reference is fixed at 0.75 for debugging purposes. The ADC and PID are not included in this simulation for simplicity. The LEB is replaced by a DFLOP instead of a counter for shorter simulation time. The output POLARITY is inverted because Power MOSFET Q6 needs 0V to turn on.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/8/PCI-CL-Simulation-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simulation-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simulation-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simulation-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simulation-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simulation-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/8/responsive/PCI-CL-Simulation-2-2xl.jpg 1600w" alt="DSPIC33 PCI Current Limit Simulation LTSPICE" width="942" height="776"></figure><p>LTSPICE SIMULATION RESULT</p><figure class="post__image">Below are some of the waveforms from the result of the simulation. The first plot pane from the top shows the PWM output running at 95% duty cycle. The 2nd plot pane from the top shows PCI_Active signal which blocks the PWM output. The truncated output PWM7H is shown in the third plot from the top. The red waveform Ix(Q6:S) is the current flow in power MOSFET Q6. The 4th plot from the top shows the momentary pulse from the comparator output PCI_SOURCE when the sense current RA3_ISENSEH reached the reference voltage DAC.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/8/waveforms-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/8/responsive/waveforms-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/8/responsive/waveforms-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/8/responsive/waveforms-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/8/responsive/waveforms-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/8/responsive/waveforms-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/8/responsive/waveforms-2-2xl.jpg 1600w" alt="DSPIC33 PCI Current Limit Simulation" width="935" height="877"></figure><p> </p><p>LTSPICE Simulation Files: <a href="https://andrewmosqueda.github.io/media/files/DSPIC33 PCI Current Limit Simulation.zip" target="_blank" rel="noopener noreferrer">DSPIC33 PCI Current Limit Simulation LTSPICE</a></p><p> </p><p> </p><p> </p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on September 29, 2021</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio box"><img class="u-author__avatar" src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="lazy" alt="Andrew Mosqueda"><div><h4 class="h6"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://andrewmosqueda.github.io/high-side-current-sense-circuit-simulation/" class="post__nav__link" rel="prev"><div class="u-small">Previous Post<h5>High Side Current Sense Circuit Simulation</h5></div></a></div><div class="post__nav__next"><a href="https://andrewmosqueda.github.io/using-the-slope-compensation-for-the-current-mode-control/" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>Using the slope compensation for the current mode control</h5></div></a></div></nav><div class="post__related box"><h3 class="box__title">Related posts</h3><div class="post__related-wrap"><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/" class="inverse">LTspice simulation of hysteretic current control for buck converter</a></h4><time datetime="2021-11-20T22:27" class="u-small">November 20, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/high-side-current-sense-circuit-simulation/" class="inverse">High Side Current Sense Circuit Simulation</a></h4><time datetime="2021-09-25T08:56" class="u-small">September 25, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/current-mode/" class="inverse">5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</a></h4><time datetime="2021-09-11T21:52" class="u-small">September 11, 2021</time></figcaption></figure></div></div></footer></article><div class="comments box"><h3 class="box__title">Comments</h3><div id="disqus_thread"></div><script>var disqus_config = function () {
                    this.page.url = 'https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/';
            		this.page.identifier = '8';
                };
            
                var disqus_loaded = false;
            
                function publiiLoadDisqus() {
                    if(disqus_loaded) {
                        return false;
                    }
            
                    var top = document.getElementById('disqus_thread').offsetTop;
            
                    if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                        disqus_loaded = true;
            
                        (function () {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    }
                }
            
                publiiLoadDisqus();
            
                window.onscroll = function() {
                    publiiLoadDisqus();
                };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></main><div class="sidebar"><section class="box featured"><h3 class="box__title">Featured</h3><ul class="featured__container"><li class="featured__item"><div><a href="https://andrewmosqueda.github.io/current-mode/" class="featured__title">5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</a> <time class="u-small" datetime="2021-09-11T21:52">September 11, 2021</time></div></li></ul></section><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__image-link"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" alt="Andrew Mosqueda"></a><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__title">Andrew Mosqueda</a> <span class="u-small">Post: 11</span></div></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a><nav><ul class="footer__nav"></ul></nav><div class="footer__follow"><a href="https://www.facebook.com/andrew.mosqueda" aria-label="Facebook"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://www.linkedin.com/in/alex-andrew-mosqueda-31197876/" aria-label="LinkedIn"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#linkedin"/></svg> </a><a href="https://www.youtube.com/channel/UCHcJ7jRLmntRZrI8h41y3Yg" aria-label="Youtube"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#youtube"/></svg></a></div><div class="footer__copyright"><p>andrewgs7311@gmail.com</p></div></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://andrewmosqueda.github.io/assets/js/scripts.min.js?v=3dc768003cc6d66c9e7bf0904e71d3e8"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>