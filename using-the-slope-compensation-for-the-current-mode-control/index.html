<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Using the slope compensation for the current mode control - Andrew Mosqueda</title><meta name="description" content="INTRODUCTION In the previous article Current Mode Converter , the PWM control is generated based from the comparison of the output of the DAC to the actual current of the high side mosfet. See illustration below. The DAC converts the digital result value of the PID&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://andrewmosqueda.github.io/using-the-slope-compensation-for-the-current-mode-control/"><link rel="alternate" type="application/atom+xml" href="https://andrewmosqueda.github.io/feed.xml"><link rel="alternate" type="application/json" href="https://andrewmosqueda.github.io/feed.json"><meta property="og:title" content="Using the slope compensation for the current mode control"><meta property="og:site_name" content="Andrew Mosqueda - Andrew Mosqueda"><meta property="og:description" content="INTRODUCTION In the previous article Current Mode Converter , the PWM control is generated based from the comparison of the output of the DAC to the actual current of the high side mosfet. See illustration below. The DAC converts the digital result value of the PID&hellip;"><meta property="og:url" content="https://andrewmosqueda.github.io/using-the-slope-compensation-for-the-current-mode-control/"><meta property="og:type" content="article"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:var(--body-font);--post-entry-font:var(--body-font);--logo-font:var(--body-font);--menu-font:var(--body-font)}</style><link rel="stylesheet" href="https://andrewmosqueda.github.io/assets/css/style.css?v=eacb492672ba3c1641d647982de266ba"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://andrewmosqueda.github.io/using-the-slope-compensation-for-the-current-mode-control/"},"headline":"Using the slope compensation for the current mode control","datePublished":"2021-11-14T16:12","dateModified":"2021-11-14T22:16","description":"INTRODUCTION In the previous article Current Mode Converter , the PWM control is generated based from the comparison of the output of the DAC to the actual current of the high side mosfet. See illustration below. The DAC converts the digital result value of the PID&hellip;","author":{"@type":"Person","name":"Andrew Mosqueda"},"publisher":{"@type":"Organization","name":"Andrew Mosqueda"}}</script></head><body><header class="topbar" id="js-header"><div class="topbar__inner"><a class="logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a></div></header><div class="content"><div class="infobar"><div class="infobar__update">Last Updated: <time datetime="2021-11-28T16:36">November 28, 2021</time></div><div class="infobar__search"><form action="https://andrewmosqueda.github.io/search.html"><input type="search" name="q" placeholder="search..." aria-label="Search input"> <button type="submit" aria-label="Submit"><svg role="presentation" focusable="false" width="15px" height="14px"><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#search"/></svg></button></form></div></div><main class="main"><article class="post"><header class="u-header post__header"><h1>Using the slope compensation for the current mode control</h1><div class="u-header__meta u-small"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="eager" class="u-header__avatar" alt="Andrew Mosqueda"><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a> <time datetime="2021-11-14T16:12">November 14, 2021</time></div></div></header><div class="post__entry u-inner"><h2>INTRODUCTION</h2><figure class="post__image">In the previous article <a href="https://andrewmosqueda.github.io/current-mode/" target="_blank" rel="noopener noreferrer"></a><a href="https://andrewmosqueda.github.io/current-mode/" target="_blank" rel="noopener noreferrer">Current Mode Converter</a> , the PWM control is generated based from the comparison of the output of the DAC to the actual current of the high side mosfet. See illustration below.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/9/close-loop.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/9/responsive/close-loop-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/9/responsive/close-loop-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/9/responsive/close-loop-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/9/responsive/close-loop-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/9/responsive/close-loop-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/9/responsive/close-loop-2xl.jpg 1600w" alt="Current Controlled Buck Converter" width="983" height="578"></figure><figure class="post__image">The DAC converts the digital result value of the PID function  into analog. The DAC was configured in DC Mode as seen on the image below.<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/9/CMP-DC-Mode.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-DC-Mode-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-DC-Mode-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-DC-Mode-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-DC-Mode-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-DC-Mode-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-DC-Mode-2xl.jpg 1600w" alt="Comparator in DC Mode" width="679" height="519"></figure><p>In the DC Mode, the output of the DAC changes only after the DACDATAH is updated.</p><p>Actually, the DAC has a slope compensation feature in which the output of the DAC ramps down after DACDATAH is updated. This method makes the control more stable. In this article I will configure the DAC from DC Mode to slope compensation mode. </p><h2>PROCEDURE</h2><ol><li>Open the master and slave projects of the current mode buck control in MPLAB IDE. The MPLAB code of the buck control project is stored here: <a href="https://andrewmosqueda.github.io/media/files/buck_ictrl.zip" target="_blank" rel="noopener noreferrer">buck_ictrl.zip</a></li><li>Right click on the master project and make it the main project.</li><li>Connect the DM330028 board to the PC. Click the "Make and Program" button on MPLAB to program the code to the dsPIC33 IC. Wait until a "Programming/Verify complete" message is prompted in the output window of MPLAB.</li><li>If we connect an oscilloscope to RB2 and RA3, we would see the waveform below. We can see that the orange waveform (RA3) shuts off after reaching the purple waveform (RB2). The RB2 is the DC value output from the DAC and RA3 is the current sense signal that is fed to the comparator. Note: RB2 is not shown in the simplified schematic that is illustrated above.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/9/RA3vsRB2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/9/responsive/RA3vsRB2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/9/responsive/RA3vsRB2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/9/responsive/RA3vsRB2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/9/responsive/RA3vsRB2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/9/responsive/RA3vsRB2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/9/responsive/RA3vsRB2-2xl.jpg 1600w" alt="waveform current mode" width="1377" height="768"></figure></li><li>Right click on the slave project and make it the main project.</li><li>Click MCC button and wait until the slave MCC is completely loaded.</li><li>After the MCC is loaded, open the Master Core Configuration.</li><li>In the Master Core Configuration window, click "Load Slave Settings from Master Configuration" button. Select the master_config.mc3 file in the master.X folder then click Open button. Wait until the Notifications [MCC] window is updated.</li><li>In the Project Resources window, click CMP1 (Don't click X) to open the CMP1 analog comparator window. Wait until the window is completely loaded.</li><li>Configure the DAC as shown below. I made the lowest value DACDATAL as 260 because this is 0 current offset value of the DM330028 current sense amplifier. In this configuration, the DAC output will start to ramp down after Slave PWM7 Trigger 1 and ramps back up after either Slave PWM7 Trigger2 or S1CMP1 Output is triggered.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/9/CMP-Slope-Mode.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-Slope-Mode-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-Slope-Mode-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-Slope-Mode-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-Slope-Mode-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-Slope-Mode-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/9/responsive/CMP-Slope-Mode-2xl.jpg 1600w" alt="Slope Mode Current Control" width="1121" height="672"></figure></li><li>In the Project Resources window, click PWM (Don't click X) to open the PWM window. Wait until the window is completely loaded.</li><li>Expand the Trigger Control Settings and configure it as shown below. Trigger 1 is triggered 1us after the start of PWM cycle. We have now configure the DAC output to start ramping down after 1us after the start of PWM cycle. Trigger 2 is triggered 25us after the start of PWM cycle. 25us is the period of the 40kHz PWM so the DAC output will go back to DACDATH at the end of the PWM cycle.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/9/Trigger-Control-Settings-2.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/9/responsive/Trigger-Control-Settings-2-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/9/responsive/Trigger-Control-Settings-2-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/9/responsive/Trigger-Control-Settings-2-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/9/responsive/Trigger-Control-Settings-2-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/9/responsive/Trigger-Control-Settings-2-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/9/responsive/Trigger-Control-Settings-2-2xl.jpg 1600w" alt="PWM Trigger Settings" width="696" height="394"></figure></li><li>Click the Generate button. Click yes button in the confirmation dialog box and wait until Generation complete is prompted in the MCC output window.</li><li>Click MCC toolbar button to close the MCC configurator application.</li><li>In the projects pane, open main.c file of the slave project.</li><li>In the PID function, add the highlighted code as shown below.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/9/PID-function.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/9/responsive/PID-function-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/9/responsive/PID-function-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/9/responsive/PID-function-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/9/responsive/PID-function-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/9/responsive/PID-function-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/9/responsive/PID-function-2xl.jpg 1600w" alt="PID function" width="773" height="147"></figure>260 is the assigned value of the DAC1DATL. The multiplier 0.003 calculation is shown below.<br><figure class="post__image"><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/9/multipler.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/9/responsive/multipler-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/9/responsive/multipler-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/9/responsive/multipler-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/9/responsive/multipler-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/9/responsive/multipler-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/9/responsive/multipler-2xl.jpg 1600w" alt="slope value multiplier calculation" width="479" height="303"></figure></li><li>Right click on the master project file and set it as the main project.</li><li>Click Make and Program button and wait until the Programming/Verify complete is prompted on the log window.</li></ol><h2>RESULT</h2><figure class="post__image">Purple waveform - DAC output<br>Orange waveform - MOSFET current sense amplifier output<br><img loading="lazy" src="https://andrewmosqueda.github.io/media/posts/9/waveform.jpg" sizes="(max-width: 48em) 100vw, 768px" srcset="https://andrewmosqueda.github.io/media/posts/9/responsive/waveform-xs.jpg 300w, https://andrewmosqueda.github.io/media/posts/9/responsive/waveform-sm.jpg 480w, https://andrewmosqueda.github.io/media/posts/9/responsive/waveform-md.jpg 768w, https://andrewmosqueda.github.io/media/posts/9/responsive/waveform-lg.jpg 1024w, https://andrewmosqueda.github.io/media/posts/9/responsive/waveform-xl.jpg 1360w, https://andrewmosqueda.github.io/media/posts/9/responsive/waveform-2xl.jpg 1600w" alt="current mode control with slope compensation" width="853" height="476"></figure><p>It can now be seen that the DAC output (purple) ramps down 1us after the MOSFET begins to conduct (orange waveform) and then quickly return back to high value after the MOSFET has turned off.</p></div><aside class="post__aside"><div class="post__last-updated u-small">This article was updated on November 14, 2021</div><div class="post__share"></div></aside><footer class="post__footer"><div class="post__bio box"><img class="u-author__avatar" src="https://andrewmosqueda.github.io/media/website/andrew.jpg" loading="lazy" alt="Andrew Mosqueda"><div><h4 class="h6"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" title="Andrew Mosqueda">Andrew Mosqueda</a></h4></div></div><nav class="post__nav box"><div class="post__nav__prev"><a href="https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/" class="post__nav__link" rel="prev"><div class="u-small">Previous Post<h5>Simulation of the PCI-Current Limit Logic of dsPIC33CH</h5></div></a></div><div class="post__nav__next"><a href="https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/" class="post__nav__link" rel="next"><div class="u-small">Next Post<h5>LTspice simulation of hysteretic current control for buck converter</h5></div></a></div></nav><div class="post__related box"><h3 class="box__title">Related posts</h3><div class="post__related-wrap"><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/ltspice-simulation-of-hysteretic-control-for-buck-converter/" class="inverse">LTspice simulation of hysteretic current control for buck converter</a></h4><time datetime="2021-11-20T22:27" class="u-small">November 20, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/simulation-of-the-pwm-control-input-pci-current-limit-logic-of-dspic33ch/" class="inverse">Simulation of the PCI-Current Limit Logic of dsPIC33CH</a></h4><time datetime="2021-09-26T17:12" class="u-small">September 26, 2021</time></figcaption></figure><figure class="post__related-item"><figcaption><h4 class="post__related-title"><a href="https://andrewmosqueda.github.io/high-side-current-sense-circuit-simulation/" class="inverse">High Side Current Sense Circuit Simulation</a></h4><time datetime="2021-09-25T08:56" class="u-small">September 25, 2021</time></figcaption></figure></div></div></footer></article><div class="comments box"><h3 class="box__title">Comments</h3><div id="disqus_thread"></div><script>var disqus_config = function () {
                    this.page.url = 'https://andrewmosqueda.github.io/using-the-slope-compensation-for-the-current-mode-control/';
            		this.page.identifier = '9';
                };
            
                var disqus_loaded = false;
            
                function publiiLoadDisqus() {
                    if(disqus_loaded) {
                        return false;
                    }
            
                    var top = document.getElementById('disqus_thread').offsetTop;
            
                    if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                        disqus_loaded = true;
            
                        (function () {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    }
                }
            
                publiiLoadDisqus();
            
                window.onscroll = function() {
                    publiiLoadDisqus();
                };</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></main><div class="sidebar"><section class="box featured"><h3 class="box__title">Featured</h3><ul class="featured__container"><li class="featured__item"><div><a href="https://andrewmosqueda.github.io/current-mode/" class="featured__title">5V to 3.3V Peak Current Mode Buck Converter in the DSPIC33CH Curiosity Development Board</a> <time class="u-small" datetime="2021-09-11T21:52">September 11, 2021</time></div></li></ul></section><section class="box authors"><h3 class="box__title">Authors</h3><ul class="authors__cotainer"><li class="authors__item"><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__image-link"><img src="https://andrewmosqueda.github.io/media/website/andrew.jpg" alt="Andrew Mosqueda"></a><div><a href="https://andrewmosqueda.github.io/authors/andrew-mosqueda/" class="authors__title">Andrew Mosqueda</a> <span class="u-small">Post: 11</span></div></li></ul></section></div><footer class="footer"><a class="footer__logo" href="https://andrewmosqueda.github.io/">Andrew Mosqueda</a><nav><ul class="footer__nav"></ul></nav><div class="footer__follow"><a href="https://www.facebook.com/andrew.mosqueda" aria-label="Facebook"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#facebook"/></svg> </a><a href="https://www.linkedin.com/in/alex-andrew-mosqueda-31197876/" aria-label="LinkedIn"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#linkedin"/></svg> </a><a href="https://www.youtube.com/channel/UCHcJ7jRLmntRZrI8h41y3Yg" aria-label="Youtube"><svg><use xlink:href="https://andrewmosqueda.github.io/assets/svg/svg-map.svg#youtube"/></svg></a></div><div class="footer__copyright"><p>andrewgs7311@gmail.com</p></div></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.navbar',
   };</script><script defer="defer" src="https://andrewmosqueda.github.io/assets/js/scripts.min.js?v=3dc768003cc6d66c9e7bf0904e71d3e8"></script><script>var images = document.querySelectorAll('img[loading]');

      for (var i = 0; i < images.length; i++) {
         if (images[i].complete) {
               images[i].classList.add('is-loaded');
         } else {
               images[i].addEventListener('load', function () {
                  this.classList.add('is-loaded');
               }, false);
         }
      }</script></body></html>